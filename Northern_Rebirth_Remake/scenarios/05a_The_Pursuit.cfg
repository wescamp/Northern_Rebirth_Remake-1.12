#textdomain wesnoth-Northern_Rebirth_Remake
[scenario]
    # Start sequence
    # Set up map, TOD scheudle, variables, place images, objects, units, execute start event. Leads the story to the crossroads
    id=05a_The_Pursuit
    name= _ "The Pursuit"
    map_data="{~add-ons/Northern_Rebirth_Remake/maps/05a_The_Pursuit.map}"
    # There is no turn limit in the scenario, whole map is underground and a special event needs to occur to achieve victory
    turns=-1
    {UNDERGROUND}
    next_scenario=Cutscene_Old_Friend
    victory_when_enemies_defeated=no

    {SCENARIO_MUSIC "underground.ogg"}
    {EXTRA_SCENARIO_MUSIC "the_deep_path.ogg"}
    {EXTRA_SCENARIO_MUSIC "vengeful.ogg"}
    {EXTRA_SCENARIO_MUSIC "suspense.ogg"}

    #define MALIFOR_ABILITIES
        [modifications]
            [object]
                silent=yes
                duration=forever
                [effect]
                    apply_to=new_animation

                    [extra_anim]
                        flag=emerge

                        halo_auto_vflip=false
                        [halo_frame]
                            duration=730
                            halo="halo/undead/light-beam-[1~7,6~1].png:[30*6,130,70*6]"
                        [/halo_frame]
                    [/extra_anim]
                [/effect]
            [/object]
        [/modifications]
    #enddef

    #define MALIFOR_DIED_BY TYPE
        [event]
            name=last breath
            first_time_only=no
            [filter]
                id=Malifor
            [/filter]
            [filter_second_attack]
                type={TYPE}
            [/filter_second_attack]

            {VARIABLE malifor_died_by {TYPE}}

            [if]
                [variable]
                    name=malifor_died_by
                    equals=impact
                [/variable]
            [then]
                [if]
                    [variable]
                        name=second_unit.race
                        equals=dwarf
                    [/variable]
                [then]
                    {VARIABLE malifor_died_by axe}
                [/then]
                [else]
                    {VARIABLE malifor_died_by pierce}
                [/else]
                [/if]
            [/then]
            [/if]
        [/event]
    #enddef

    #define MALIFOR_POWER
        [kill]
            x=$unit.x
            y=$unit.y
        [/kill]

        {UNIT 4 "Ancient Lich" $malifor_will_respawn_at_x $malifor_will_respawn_at_y (
            id=Malifor
            name= _ "Malifor"
            profile=portraits/Malifor.png
            canrecruit=yes
            moves=0
            attacks_left=0
            {MALIFOR_ABILITIES}
        )}
        {TEAM_COLOR_OVERRIDE id=Malifor red}

        [sound]
            name=magic-dark-big.ogg
        [/sound]
        {ANIMATE_UNIT Malifor emerge ()}
    #enddef

    #define FORCES_UNDEAD SIDE SIDE_VARIABLE
        #ifndef EASY
            [event]
                name=prerecruit
                first_time_only=no

                [filter]
                    side={SIDE}
                [/filter]

                {VARIABLE_OP forces_undead[{SIDE_VARIABLE}] add 1}
            [/event]

            [event]
                name=die
                first_time_only=no

                [filter]
                    side={SIDE}
                [/filter]

                {VARIABLE_OP forces_undead[{SIDE_VARIABLE}] sub 1}
            [/event]
        #endif
    #enddef

    #define ORDER_ATTACK SIDE ARMY
        [if]
            [have_unit]
                side={SIDE}
                canrecruit=yes
            [/have_unit]
            [and]
                [variable]
                    name=order_attack[{ARMY}]
                    greater_than=0
                [/variable]
            [/and]
        [then]
            {RANDOM 1..3}
            {VARIABLE_OP beholder_gate_lock[{ARMY}] add $random}
            {VARIABLE order_attack[{ARMY}] 0}
        [/then]
        [/if]
    #enddef

    #define OBJECTIVES_PURSUIT DESCRIPTION_WIN OBJECTIVES_LOSE
        [objectives]
            side=1
            [objective]
                description={DESCRIPTION_WIN}
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Tallin"
                condition=lose
            [/objective]
            {OBJECTIVES_LOSE}

            {GOLD_CARRYOVER_ALL}
        [/objectives]
    #enddef

    #define AI_UNDEAD
        [ai]
            aggression=1.0
            [avoid]
                x=29,30,30,31,31,32,33,34,35,35,36,37,37,37,37,38,38,38,38,39,39,39,39,40,40,40
                y=25-26,25,29-31,26,28-32,26-32,28-32,27-32,27-33,37,26-37,27-28,31,33-34,36-37,27-28,30,34,38-39,28-30,34,36,38-40,29-30,34-37,39
            [/avoid]
        [/ai]
    #enddef

    #define UNIT_AI_GUARD X Y
        [ai]
            [vars]
                home_loc="loc({X},{Y})"
            [/vars]
        [/ai]
    #enddef

    #define PUT_MALIFOR_GUARD TYPE X Y
        [unit]
            type={TYPE}
            x={X}
            y={Y}
            side=3
            {UNIT_AI_GUARD {X} {Y}}
        [/unit]
    #enddef

    #define MAULER TYPE ROLE
        [if]
            [not]
                [have_unit]
                    role={ROLE}
                [/have_unit]
            [/not]
        [then]
            [role]
                type={TYPE}
                role={ROLE}
            [/role]

            [recall]
                role={ROLE}
            [/recall]
        [/then]
        [/if]
    #enddef

    #define RECALL_MAULER ROLE
        # Recall the most effective unit against skeletons
        # If fails get just anyone suitable for sacrifice
        [role]
            type=Fugitive
            role={ROLE}
        [/role]

        [recall]
            role={ROLE}
        [/recall]

        {MAULER Highwayman {ROLE}}
        {MAULER Outlaw {ROLE}}
        {MAULER Bandit {ROLE}}
        {MAULER Huntsman {ROLE}}
        {MAULER Ranger {ROLE}}
        {MAULER Footpad {ROLE}}
        {MAULER Thug {ROLE}}
        {MAULER Trapper {ROLE}}

        [if]
            [not]
                [have_unit]
                    role={ROLE}
                [/have_unit]
            [/not]
        [then]
            [role]
                side=1
                [not]
                    id=Tallin
                [/not]
                [not]
                    id=Camerin
                [/not]
                role={ROLE}
            [/role]

            [recall]
                role={ROLE}
            [/recall]
        [/then]
        [/if]
    #enddef

    #define RECALL_DWARVEN_MAULER ROLE
        # Recall a most effective dwarven unit against skeletons
        [role]
            [not]
                id=Hamel
            [/not]
            type=Dwarvish Lord
            role={ROLE}
        [/role]
                
        [recall]
            role={ROLE}
        [/recall]

        {MAULER "Dwarvish Steelclad" {ROLE}}
        {MAULER "Dwarvish Dragonguard" {ROLE}}
        {MAULER "Dwarvish Explorer" {ROLE}}
        {MAULER "Dwarvish Thunderguard" {ROLE}}
        {MAULER "Dwarvish Pathfinder" {ROLE}}
        {MAULER "Dwarvish Fighter" {ROLE}}
        {MAULER "Dwarvish Thunderer" {ROLE}}
        {MAULER "Dwarvish Scout" {ROLE}}
    #enddef

    #define GOLD_CHEST AMOUNT X Y MESSAGE
        [event]
            name=moveto
            [filter]
                x={X}
                y={Y}
                side=1
            [/filter]

            {SPEAKER_GENERIC (speaker=unit) {MESSAGE}}
            [gold]
                side=1
                amount={AMOUNT}
            [/gold]
            [remove_item]
                x={X}
                y={Y}
            [/remove_item]
        [/event]
    #enddef

    #define OPEN_DWARVEN_DOOR X Y
        [if]
            [variable]
                name=unit.id
                not_equals=
            [/variable]
        [then]
            [store_unit]
                [filter]
                    id=$unit.id
                [/filter]
                kill=yes
                variable=assaulter
            [/store_unit]

            {VARIABLE assaulter.moves 0}

            [unstore_unit]
                variable=assaulter
            [/unstore_unit]

            {CLEAR_VARIABLE assaulter}
        [/then]
        [/if]

        [terrain]
            x={X}
            y={Y}
            terrain=Uu
        [/terrain]
    #enddef

    #define COMMAND_DOOR DOOR X Y
        [command]
            {VARIABLE {DOOR} 1}
            {OPEN_DWARVEN_DOOR {X} {Y}}
        [/command]
    #enddef

    #define DWARVEN_DOOR DOOR OPEN_X OPEN_Y ACTION
        [event]
            name=moveto
            first_time_only=no

            [filter]
                side=1
                x={OPEN_X}
                y={OPEN_Y}
            [/filter]

            [if]
                [variable]
                    name={DOOR}
                    less_than=1
                [/variable]
            [then]
                [message]
                    speaker=narrator
                    image=scenery/dwarven-doors-closed.png
                    message= _ "These are doors that can be opened. After this action $unit.name will lose all remaining move points in this turn."
                    [option]
                        message= _ "(<i>Open it</i>)"
                        {ACTION}
                    [/option]
                    [option]
                        message= _ "(<i>Leave it</i>)"
                        [command]
                            [allow_undo][/allow_undo]
                        [/command] 
                    [/option]
                [/message]
            [/then]
            [else]
                [allow_undo][/allow_undo]
            [/else]
            [/if]
        [/event]
    #enddef

    #define COMMAND_DOOR_STORAGE1 DOOR X Y
        [command]
            {SPEAKER_GENERIC (speaker=unit) ( _ "A door, and a big, big lock, hmmm...")}
            {SPEAKER_GENERIC (speaker=unit) ( _ "Sorry folks, this is just too tempting.")}
            {SPEAKER_GENERIC (speaker=unit) ( _ "(<i>Smash</i>)")}
            {VARIABLE {DOOR} 1}
            {OPEN_DWARVEN_DOOR {X} {Y}}
        [/command]
    #enddef

    #define COMMAND_DOOR_STORAGE2 DOOR X Y
        [command]
            {SPEAKER_GENERIC (speaker=unit) ( _ "Hmmm, this door sure is locked up pretty tight. I wonder what’s behind it.")}
            {SPEAKER_GENERIC (speaker=unit) ( _ "(<i>Smash</i>)")}
            {VARIABLE {DOOR} 1}
            {OPEN_DWARVEN_DOOR {X} {Y}}
        [/command]
    #enddef

    #define AREA_DESCRIPTION X Y DESCRIPTION IMAGE COMMENT_WML
        [event]
            name=moveto
            [filter]
                side=1
                x={X}
                y={Y}
            [/filter]

            [message]
                speaker=narrator
                message={DESCRIPTION}
                image={IMAGE}
            [/message]
            {COMMENT_WML}
            [allow_undo][/allow_undo]
        [/event]
    #enddef

    #define AREA_STORAGE X Y COMMENT
        {PLACE_IMAGE scenery/rock-cairn.png {X} {Y}}
        {AREA_DESCRIPTION {X} {Y} ( _ "Warning! These bottles contain toxic waste. Causes disintegration on contact.") "scenery/rock-cairn.png" (
            {SPEAKER_GENERIC (speaker=unit) {COMMENT}}
        )}
    #enddef

    #define AREA_STORAGE_SPEAK AREA_X AREA_Y STORAGE_Y
        [event]
            name=moveto

            [filter]
                side=1
                x={AREA_X}
                y={AREA_Y}
            [/filter]

            [if]
                [variable]
                    name=unit.y
                    less_than={STORAGE_Y}
                [/variable]
            [then]
                {SPEAKER_GENERIC (speaker=unit) ( _ "Holy water! For a certainty, those skeletons won’t like us getting our hands on this stuff. But that’s probably why they kept them back here in the first place.")}
            [/then]
            [else]
                {SPEAKER_GENERIC (speaker=unit) ( _ "Oh yeah, holy water!")}
            [/else]
            [/if]
        [/event]
    #enddef

    #define CORPSE X Y COMMENT
        {PLACE_IMAGE "floor-corpse.png" {X} {Y}}

        [event]
            name=moveto

            [filter]
                side=1
                x={X}
                y={Y}
            [/filter]

            {SPEAKER_GENERIC (speaker=unit) {COMMENT}}
            [allow_undo][/allow_undo]
        [/event]
    #enddef

    #define BLIND_END X Y
        [event]
            name=moveto

            [filter]
                side=1
                x={X}
                y={Y}
            [/filter]

            {SPEAKER_GENERIC (speaker=unit) ( _ "Just great, I am cold, wet, and tired and what have we here? Another dead end. This place is starting to get on my nerves!")}
        [/event]
    #enddef

    #define REMOVE_TERRAIN_OBJECT X Y
        [store_locations]
            x,y={X},{Y}
            variable=terrain_object
        [/store_locations]

        [set_variables]
            name=item_object

            [split]
                list=$terrain_object.terrain
                key=terrain
                separator="^"
            [/split]
        [/set_variables]

        [terrain]
            x,y={X},{Y}
            terrain=$item_object[0].terrain
        [/terrain]

        {CLEAR_VARIABLE terrain_object}
        {CLEAR_VARIABLE item_object}
    #enddef

    #define PRISONER_KRASH DOOR_X DOOR_Y CELL_X CELL_Y PASSAGE_X PASSAGE_Y WALL_X WALL_Y
        {PLACE_IMAGE "units/drakes/burner.png~RC(magenta>red)" {CELL_X} {CELL_Y}}

        [terrain]
            x={CELL_X}
            y={CELL_Y}
            terrain=^Xo
            layer=overlay
        [/terrain]
        [terrain]
            x={WALL_X}
            y={WALL_Y}
            terrain=Xu
        [/terrain]

        [event]
            name=moveto
            [filter]
                side=1
                x={DOOR_X}
                y={DOOR_Y}
            [/filter]

            [remove_item]
                x={CELL_X}
                y={CELL_Y}
            [/remove_item]
            {REMOVE_TERRAIN_OBJECT {CELL_X} {CELL_Y}}
            {UNIT 1 "Drake Burner" {CELL_X} {CELL_Y} (
                id=Krash
                name= _ "Krash"
                unrenamable=yes
                [modifications]
                    {TRAIT_LOYAL}
                    {TRAIT_RESILIENT}
                [/modifications]
                {IS_LOYAL}
            )}
            [redraw]
                side=1
            [/redraw]
            # I'm not checking for existence of Camerin since the dialogue still looks decent without his lines.
            [if]
                [variable]
                    name=unit.id
                    not_equals=Camerin
                [/variable]
            [then]
                {SPEAKER_GENERIC (speaker=unit) ( _ "Holy cow! What did I just let out of that cell! Look out everyone.")}
            [/then]
            [/if]
            {SPEAKER_GENERIC (speaker=Camerin) ( _ "Oooooh, cool, it’s a drake!")}
            {SPEAKER_GENERIC (speaker=Krash) ( _ "(<i>Whimper</i>)")}
            {SPEAKER_GENERIC (speaker=unit) (_ "Bright Gods, such a fierce creature whimpering! What the heck have they done to it?")}
            {SPEAKER_GENERIC (speaker=Camerin) ( _ "The bastards!")}
            # On the other hand, the following two look awkward without Morvin in play.
            [if]
                [have_unit]
                    id="Father Morvin"
                [/have_unit]
            [then]
                {SPEAKER_GENERIC (speaker=Father Morvin) ( _ "Probably another one of Malifor’s experiments.")}
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "I don’t know, see if it talks.")}
            [/then]
            [/if]
            {SPEAKER_GENERIC (speaker=unit) ( _ "Hey, big guy. We aren’t gonna hurt you. We wanna be your friends.")}
            {SPEAKER_GENERIC (speaker=Krash) ( _ "... Not... going... to... hurt... me?")}
            [if]
                [variable]
                    name=unit.id
                    not_equals=Tallin
                [/variable]
            [then]
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Hey, it talks!")}
            [/then]
            [else]
                {SPEAKER_GENERIC (role=Supporter) ( _ "Hey, it talks!")}
            [/else]
            [/if]
            [if]
                [variable]
                    name=unit.id
                    not_equals=Camerin
                [/variable]
            [then]
                {SPEAKER_GENERIC (speaker=Camerin) ( _ "It’s a ‘he’, and yes, they’re actually very intelligent creatures.")}
            [/then]
            [/if]
            {SPEAKER_GENERIC (speaker=unit) ( _ "Hush! I am trying to talk to him. Nope, we’ll never hurt you. But if you want to you can hurt some skeletons.")}
            # wmllint: no spellcheck
            {SPEAKER_GENERIC (speaker=Krash) ( _ "Skeletons! GRRRR!!")}
            {SPEAKER_GENERIC (speaker=unit) ( _ "Look out! He is ready to go! Hey, is that smoke coming out of his ears?")}
            {SPEAKER_GENERIC (speaker=unit) ( _ "And look at this, there is some sort of opening in the back of his cell...")}
            {SPEAKER_GENERIC (speaker=Krash) ( _ "It’s an escape tunnel. The hole wasn’t big enough for me to go through but one you little guys you might fit.")}
            {SPEAKER_GENERIC (speaker=unit) ( _ "Hmmm, it is pretty small, let’s see if we can make it bigger.")}
            # Open the escape tunnel by replacing wall tile with a cave floor hex
            {OPEN_DWARVEN_DOOR {PASSAGE_X} {PASSAGE_Y}}
            {SPEAKER_GENERIC (speaker=unit) ( _ "There we go. Now let’s see where this tunnel leads to.")}

            {VARIABLE krash_alive 1}

            # Set up a flavour attack event for Krash, placed as a subevent since there is no need to have it in memory before he's found
            [event]
                name=attack
                [filter]
                    id=Krash
                [/filter]

                # wmllint: no spellcheck
                {SPEAKER_GENERIC (speaker=Krash) ( _ "ROOOAARR!")}
                {SPEAKER_GENERIC (role=Supporter) ( _ "Whoa! Maybe he isn’t so friendly after all... or at least to some things.")}
            [/event]
        [/event]
    #enddef

    #define PRISONER_ELENIA DOOR_X DOOR_Y CELL_X CELL_Y
        {PLACE_IMAGE "units/elves-wood/druid.png~RC(magenta>red)" {CELL_X} {CELL_Y}}

        [terrain]
            x={CELL_X}
            y={CELL_Y}
            terrain=^Xo
            layer=overlay
        [/terrain]

        [event]
            name=moveto
            [filter]
                side=1
                x={DOOR_X}
                y={DOOR_Y}
            [/filter]

            [remove_item]
                x={CELL_X}
                y={CELL_Y}
            [/remove_item]
            {REMOVE_TERRAIN_OBJECT {CELL_X} {CELL_Y}}
            {UNIT 1 "Elvish Druid" {CELL_X} {CELL_Y} (
                id=Elenia
                name= _ "Elenia"
                profile=portraits/Elenia.png
                hitpoints=1
                unrenamable=yes
                [modifications]
                    {TRAIT_LOYAL}
                    {TRAIT_HEALTHY}
                [/modifications]
                {IS_LOYAL}
            )}
            [redraw]
                side=1
            [/redraw]
            {SPEAKER_GENERIC (speaker=unit) ( _ "Oh my, she is almost dead!")}
            # Depending whether or not Thera has been, freed dialog describes Elenia healing herself or being healed.
            [if]
                [have_unit]
                    id="Sister Thera"
                [/have_unit]
            [then]
                [if]
                    [variable]
                        name=unit.id
                        not_equals=Sister Thera
                    [/variable]
                [then]
                    {SPEAKER_GENERIC (speaker=Sister Thera) ( _ "Here, let me see her.")}
                    {EFFECT_TELEPORTATION_TEMPORARY "Sister Thera"}
                    {EFFECT_TELEPORTATION_TEMPORARY $unit.id}
                    {ANIMATE_UNIT $unit.id pre_teleport ()}
                    [store_unit]
                        [filter]
                            id=$unit.id
                        [/filter]
                        variable=soldier
                        kill=yes
                    [/store_unit]
                    [store_unit]
                        [filter]
                            id=Sister Thera
                        [/filter]
                        variable=healer
                    [/store_unit]
                    {ANIMATE_UNIT "Sister Thera" pre_teleport ()}

                    {VARIABLE soldier.x $healer.x}
                    {VARIABLE soldier.y $healer.y}

                    {TELEPORT_UNIT id="Sister Thera" {DOOR_X} {DOOR_Y}}
                    {ANIMATE_UNIT "Sister Thera" post_teleport ()}

                    [unstore_unit]
                        variable=soldier
                    [/unstore_unit]
                    {ANIMATE_UNIT $unit.id post_teleport ()}

                    {CLEAR_VARIABLE soldier}
                    {CLEAR_VARIABLE healer}
                    {SPEAKER_GENERIC (speaker=Tallin) ( _ "Was that a teleport you just did? Wow, you guys are good!")}
                    {SPEAKER_GENERIC (speaker=Father Morvin) ( _ "(<i>Wink... wink.</i>)")}
                [/then]
                [/if]
                {SPEAKER_GENERIC (speaker=Sister Thera) ( _ "Here, this will help her.")}
                [sound]
                    name=heal.wav
                [/sound]
                {SPEAKER_GENERIC (speaker=Elenia) ( _ "Uh... where... am... I...?")}
                {SPEAKER_GENERIC (speaker=Sister Thera) ( _ "You are in the dungeons of Malifor. These brave people have just released you.")}
                {SPEAKER_GENERIC (speaker=Elenia) ( _ "... Thanks.")}
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "No problem. Sister Thera, you take care of her. If she wants to join us she would make a powerful ally.")}
                {SPEAKER_GENERIC (speaker=Elenia) ( _ "Yes, I would... like to join... you Lord Tallin.")}
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Just Tallin; I am no lord. But gee, that sure is some powerful spell you used on her, Sister. She is looking better already.")}
                {SPEAKER_GENERIC (speaker=Elenia) ( _ "And I feel better too. Now let’s get back at that disgusting skeleton.")}
            [/then]
            [else]
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "I wish we had some healers with us. Just try to help her the best you can.")}
                {SPEAKER_GENERIC (speaker=unit) ( _ "Here, I hope that helps.")}
                {SPEAKER_GENERIC (speaker=Elenia) ( _ "Uh... where... am... I...?")}
                {SPEAKER_GENERIC (speaker=unit) ( _ "You are in the dungeons of Malifor. We have just released you.")}
                {SPEAKER_GENERIC (speaker=Elenia) ( _ "... Thanks.")}
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "No problem. Just take it easy. If you would like to join us your help could mean life or death for a lot of us.")}
                {SPEAKER_GENERIC (speaker=Elenia) ( _ "Yes, I would... like to join... you Lord Tallin.")}
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Just Tallin, I am no lord. And you are looking better already.")}
                [sound]
                    name=heal.wav
                [/sound]
                {SPEAKER_GENERIC (speaker=Elenia) ( _ "Oh, just a few tricks I know, otherwise I probably would be dead by now. But let’s get back at that disgusting skeleton.")}
            [/else]
            [/if]
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "Why did the bag of bones capture you in the first place?")}
            {SPEAKER_GENERIC (speaker=Elenia) ( _ "Because he thought I was pretty.")}
            # wmllint: local spelling Geez nutcase
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "That old skeleton? Geez, what a nutcase.")}
            {SPEAKER_GENERIC (speaker=Elenia) ( _ "You’re telling me.")}
        [/event]
    #enddef

    #define PRISONER_THERA DOOR_X DOOR_Y CELL_X CELL_Y
        {PLACE_IMAGE "units/human-magi/white-mage+female.png~RC(magenta>red)" {CELL_X} {CELL_Y}}

        [terrain]
            x={CELL_X}
            y={CELL_Y}
            terrain=^Xo
            layer=overlay
        [/terrain]

        [event]
            name=moveto
            [filter]
                side=1
                x={DOOR_X}
                y={DOOR_Y}
            [/filter]

            [remove_item]
                x={CELL_X}
                y={CELL_Y}
            [/remove_item]
            {REMOVE_TERRAIN_OBJECT {CELL_X} {CELL_Y}}
            {UNIT 1 "White Mage" {CELL_X} {CELL_Y} (
                gender=female
                id=Sister Thera
                name= _ "Sister Thera"
                profile=portraits/Sister_Thera.png
                unrenamable=yes
                [modifications]
                    {TRAIT_LOYAL}
                    {TRAIT_QUICK}
                [/modifications]
                {IS_LOYAL}
            )}
            [redraw]
                side=1
            [/redraw]
            {SPEAKER_GENERIC (speaker=Sister Thera) ( _ "Freedom at last. Thank you, Lord Tallin.")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "Just ‘Tallin’. I am no Lord, just a humble peasant trying to restore our people to freedom.")}
            [if]
                [have_unit]
                    id="Father Morvin"
                [/have_unit]
            [then]
                {SPEAKER_GENERIC (speaker=Sister Thera) ( _ "Morvin!")}
                {SPEAKER_GENERIC (speaker=Father Morvin) ( _ "Thera!")}
                [if]
                    [variable]
                        name=unit.id
                        not_equals=Father Morvin
                    [/variable]
                [then]
                    {SPEAKER_GENERIC (speaker=unit) ( _ "Please, folks, not now.")}
                [/then]
                [else]
                    {SPEAKER_GENERIC (role=Supporter) ( _ "Please, folks, not now.")}
                [/else]
                [/if]
                {SPEAKER_GENERIC (speaker=Sister Thera) ( _ "Oh, sorry.")}
            [/then]
            [else]
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Who are you? How did you end up down here?")}
                {SPEAKER_GENERIC (speaker=Sister Thera) ( _ "I am called Sister Thera. My husband Morvin and I were advisers and healers for the dwarvish nobles of Knalga. We could not save them from Khazg Black-Tusk’s troops, but we survived the orcs and trolls only to be captured when these skeletons appeared.")}
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Funny, why would the bonebag keep you as his prisoners? He didn’t seem to be the merciful type.")}
                {SPEAKER_GENERIC (speaker=Sister Thera) ( _ "He didn’t keep us alive out of mercy, he wanted to study us to see if there was a way to counteract our arcane attacks. His kind are very vulnerable to such attacks, as I am sure you know by now.")}
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Indeed, that is good to know. But you are now free to go wherever you like. May the Lords of Light guide your path.")}
                {SPEAKER_GENERIC (speaker=Sister Thera) ( _ "If you have no objection, Tallin, we would like to join you. These northlands are hardly safe these days for anyone to be traveling on their own, and we could lend valuable help to your cause.")}
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Very well, you are most welcome to join us.")}
                {SPEAKER_GENERIC (speaker=Sister Thera) ( _ "Thank you, Tallin.")}
            [/else]
            [/if]
        [/event]
    #enddef

    #define PRISONER_MORVIN DOOR_X DOOR_Y CELL_X CELL_Y
        {PLACE_IMAGE "units/human-magi/white-mage.png~RC(magenta>red)" {CELL_X} {CELL_Y}}

        [terrain]
            x={CELL_X}
            y={CELL_Y}
            terrain=^Xo
            layer=overlay
        [/terrain]

        [event]
            name=moveto
            [filter]
                side=1
                x={DOOR_X}
                y={DOOR_Y}
            [/filter]

            [remove_item]
                x={CELL_X}
                y={CELL_Y}
            [/remove_item]
            {REMOVE_TERRAIN_OBJECT {CELL_X} {CELL_Y}}
            {UNIT 1 "White Mage" {CELL_X} {CELL_Y} (
                id=Father Morvin
                name= _ "Father Morvin"
                profile=portraits/Father_Morvin.png
                unrenamable=yes
                [modifications]
                    {TRAIT_LOYAL}
                    {TRAIT_RESILIENT}
                [/modifications]
                {IS_LOYAL}
            )}
            [redraw]
                side=1
            [/redraw]
            # Some dialogue
            {SPEAKER_GENERIC (speaker=Father Morvin) ( _ "Finally! I am free. Lord Tallin, I am forever in your debt! We will follow you to the end of the world if need be.")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "It’s just ‘Tallin’, no ‘Lord’. And no problem.")}
            # If he was freed after sister Thera,
            # there is no need to repeat the exposition
            [if]
                [have_unit]
                    id="Sister Thera"
                [/have_unit]
            [then]
                {SPEAKER_GENERIC (speaker=Sister Thera) ( _ "Morvin!")}
                {SPEAKER_GENERIC (speaker=Father Morvin) ( _ "Thera!")}
                [if]
                    [variable]
                        name=unit.id
                        not_equals=Sister Thera
                    [/variable]
                [then]
                    {SPEAKER_GENERIC (speaker=unit) ( _ "Please, folks, not now.")}
                [/then]
                [else]
                    {SPEAKER_GENERIC (role=Supporter) ( _ "Please, folks, not now.")}
                [/else]
                [/if]
                {SPEAKER_GENERIC (speaker=Sister Thera) ( _ "Oh, sorry.")}
            [/then]
            # Else explain how did they end up down here and why are they still alive
            [else]
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Who are you? How did you end up down here?")}
                {SPEAKER_GENERIC (speaker=Father Morvin) ( _ "I am called Father Morvin. My wife, Thera and I were advisers and healers for the dwarvish nobles. We could not shield them from the wrath of Khazg Black-Tusk, but we survived the orcs and trolls — only to be captured by these skeletons.")}
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Funny, why would the bonebag keep you as his prisoners? He doesn’t really seem to be the merciful type.")}
                {SPEAKER_GENERIC (speaker=Father Morvin) ( _ "He didn’t keep us alive out of mercy, he wanted to study us to see if there was a way to counteract our arcane attacks. His kind are very vulnerable to such attacks.")}
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Indeed, that is good to know. But you are now free to go wherever you like. May the Lords of Light guide your path.")}
                {SPEAKER_GENERIC (speaker=Father Morvin) ( _ "As I have said, Tallin, I am eternally in your debt, and I take my debts seriously. If you have no objection, I will serve you until one of us departs this life.")}
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Oh, think nothing of it. Let no talk of debts come between us; rather let us join hands as allies in restoring these Northlands to sanity.")}
                {SPEAKER_GENERIC (speaker=Father Morvin) ( _ "Thank you, Tallin.")}
            [/else]
            [/if]
        [/event]
    #enddef

    #define PRISONER_DEAD DOOR_X DOOR_Y CELL_X CELL_Y
        {VARIABLE prisoner_dead[0] {DOOR_X}}
        {VARIABLE prisoner_dead[1] {DOOR_Y}}
        {VARIABLE prisoner_dead[2] {CELL_X}}
        {VARIABLE prisoner_dead[3] {CELL_Y}}
    #enddef

    #define PUT_PRISONER CELL_NUMBER_MIN CELL_NUMBER_MAX PRISONER PRISONER_WML
        [if]
            [variable]
                name=cell_free
                greater_than=0
            [/variable]
        [then]
            {RANDOM {CELL_NUMBER_MIN}..{CELL_NUMBER_MAX}}
            {VARIABLE captive_cell $random}
        [/then]
        [else]
            {VARIABLE captive_cell 0}
        [/else]
        [/if]

        {VARIABLE captive[{PRISONER}] $cell_location[$cell[$captive_cell]]}

        [if]
            [variable]
                name=captive_cell
                less_than=$cell_free
            [/variable]
        [then]
            {VARIABLE cell[$captive_cell] $cell[$cell_free]}
        [/then]
        [/if]

        {CLEAR_VARIABLE cell[$cell_free]}
        {CLEAR_VARIABLE random}

        {VARIABLE_OP cell_free sub 1}

        {PRISONER_WML}
    #enddef

    #define PUT_GOLD_CHEST CHEST_NUMBER_MIN CHEST_NUMBER_MAX CRATE GOLD_AMOUNT MESSAGE
        [if]
            [variable]
                name=chest_free
                greater_than=0
            [/variable]
        [then]
            {RANDOM {CHEST_NUMBER_MIN}..{CHEST_NUMBER_MAX}}
            {VARIABLE gold_chest $random}
        [/then]
        [else]
            {VARIABLE gold_chest 0}
        [/else]
        [/if]

        {VARIABLE chest[{CRATE}] $chest_location[$gold_chest]}

        [if]
            [variable]
                name=gold_chest
                less_than=$chest_free
            [/variable]
        [then]
            {VARIABLE chest_location[$gold_chest] $chest_location[$chest_free]}
        [/then]
        [/if]

        {CLEAR_VARIABLE chest_location[$chest_free]}
        {CLEAR_VARIABLE random}

        {VARIABLE_OP chest_free sub 1}

        [switch]
            variable=chest[{CRATE}]
            [case]
                value="0"
                {GOLD_CHEST {GOLD_AMOUNT} 8 20 {MESSAGE}}
            [/case]
            [case]
                value="1"
                {GOLD_CHEST {GOLD_AMOUNT} 6 20 {MESSAGE}}
            [/case]
            [case]
                value="2"
                {GOLD_CHEST {GOLD_AMOUNT} 5 19 {MESSAGE}}
            [/case]
            [case]
                value="3"
                {GOLD_CHEST {GOLD_AMOUNT} 7 17 {MESSAGE}}
            [/case]
            [case]
                value="4"
                {GOLD_CHEST {GOLD_AMOUNT} 11 16 {MESSAGE}}
            [/case]
            [else]
                {GOLD_CHEST {GOLD_AMOUNT} 10 14 {MESSAGE}}
            [/else]
        [/switch]
    #enddef

    #define PUT_BONES TREASURE X Y
        [terrain]
            x={X}
            y={Y}
            terrain=^Xo
            layer=overlay
        [/terrain]

        [if]
            [variable]
                name=bones_free
                greater_than=0
            [/variable]
        [then]
            {RANDOM 0..$bones_free}
            {VARIABLE bones_state $random}
        [/then]
        [else]
            {VARIABLE bones_state 0}
        [/else]
        [/if]

        {VARIABLE bones[{TREASURE}] $bones_appearance[$bones_state]}

        [if]
            [variable]
                name=bones_state
                less_than=$bones_free
            [/variable]
        [then]
            {VARIABLE bones_appearance[$bones_state] $bones_appearance[$bones_free]}
        [/then]
        [/if]

        {CLEAR_VARIABLE bones_appearance[$bones_free]}
        {CLEAR_VARIABLE random}

        {VARIABLE_OP bones_free sub 1}

        [switch]
            variable=bones[{TREASURE}]
            [case]
                value="0"
                {PLACE_IMAGE "units/human-loyalists/lieutenant-die-9.png~RC(magenta>green)" {X} {Y}}
            [/case]
            [case]
                value="1"
                {PLACE_IMAGE "units/undead-skeletal/revenant-dying-7.png~RC(magenta>green)" {X} {Y}}
            [/case]
            [case]
                value="2"
                {PLACE_IMAGE "units/undead-skeletal/archer-die-13.png~RC(magenta>green)" {X} {Y}}
            [/case]
            [else]
                {PLACE_IMAGE "units/undead-skeletal/skeleton/skeleton-dying-7.png~RC(magenta>green)" {X} {Y}}
            [/else]
        [/switch]
    #enddef

    #define REVEAL_SIDE SIDE NAME
        [if]
            [variable]
                name={NAME}
                less_than=1
            [/variable]
        [then]
            [modify_side]
                side={SIDE}
                hidden=no
            [/modify_side]

            {VARIABLE {NAME} 1}
        [/then]
        [/if]
    #enddef

    #define REVEAL_UNDEAD SIDE SIDE_NAME
        [event]
            name=sighted,moveto
            [filter]
                side={SIDE}
                [filter_vision]
                    viewing_side=1
                [/filter_vision]
            [/filter]

            {REVEAL_SIDE {SIDE} {SIDE_NAME}}
        [/event]
    #enddef

    #define NAGA_ENCOUNTER AREA_X AREA_Y
        [event]
            name=moveto

            [filter]
                side=1
                x={AREA_X}
                y={AREA_Y}
            [/filter]

            {SPEAKER_GENERIC (speaker=unit) ( _ "Hold it, people, there is something just ahead!")}
            {GENERIC_UNIT 2 "Naga Warrior" 32 10}
            {GENERIC_UNIT 2 "Naga Fighter" 32 11}
            #ifndef EASY
                {GENERIC_UNIT 2 "Naga Fighter" 33 10}
            #ifndef NORMAL
                {GENERIC_UNIT 2 "Naga Fighter" 33 11}
            #ifndef HARD
                {GENERIC_UNIT 2 "Naga Fighter" 33 12}
            #endif
            #endif
            #endif
            [remove_shroud]
                side=1
                x=31-34
                y=9-12
            [/remove_shroud]
            [redraw]
                side=1
            [/redraw]
            {SPEAKER_GENERIC (type=Naga Warrior) ( _ "(<i>Sniff</i>) I smell humans.")}
            {SPEAKER_GENERIC (type=Naga Fighter) ( _ "You are just plain deaf. I heard them coming from a mile off.")}
            {SPEAKER_GENERIC (type=Naga Warrior) ( _ "Ahh, shut up. Let’s go kill them.")}
        [/event]
    #enddef

    #define BONES_ENCOUNTER X Y
        [if]
            [variable]
                name=bones_encounter
                less_than=1
            [/variable]
        [then]
            [remove_item]
                x={X}
                y={Y}
            [/remove_item]

            {REMOVE_TERRAIN_OBJECT {X} {Y}}
            {REVEAL_SIDE 2 reveal_monsters}
            {UNIT 2 Draug {X} {Y} (
                id="Dread Warrior"
                profile=portraits/undead/transparent/draug-2.png
                [modifications]
                    [object]
                        silent=yes
                        duration=forever
                        [effect]
                            apply_to=attack
                            range=melee
                            [set_specials]
                                mode=append
                                {WEAPON_SPECIAL_DRAIN}
                            [/set_specials]
                        [/effect]
                        [effect]
                            apply_to=new_animation

                            [extra_anim]
                                flag=emerge

                                {HALO_FRAME_SAURIAN}
                            [/extra_anim]
                        [/effect]
                    [/object]
                [/modifications]
            )}

            [sound]
                name=slowed.wav
            [/sound]
            {ANIMATE_UNIT "Dread Warrior" emerge ()}
            [sound]
                name=skeleton-big-hit-3.ogg
            [/sound]

            {SPEAKER_GENERIC (id="Dread Warrior") ( _ "You shouldn't have come here.")}

            {VARIABLE bones_encounter 1}
        [/then]
        [/if]
    #enddef

    #define TREASURE_ARTIFACT X Y AREA_X AREA_Y
        {PUT_BONES 0 {X} {Y}}

        [event]
            name=moveto

            [filter]
                side=1
                x={AREA_X}
                y={AREA_Y}
            [/filter]

            {REMOVE_TERRAIN_OBJECT {X} {Y}}

            [remove_item]
                x={X}
                y={Y}
            [/remove_item]

            {SPEAKER_GENERIC (speaker=unit) ( _ "I have found something.")}
            {PLACE_IMAGE items/staff.png {X} {Y}}
        [/event]

        [event]
            name=moveto

            [filter]
                side=1
                id=Abhai
                x,y={X},{Y}
            [/filter]

            [if]
                [variable]
                    name=got_rod_of_justice
                    less_than=1
                [/variable]
            [then]
                {INCIDENTAL_MUSIC "sad.ogg"}
                {SPEAKER_GENERIC (speaker=Abhai) ( _ "The Rod of Justice! What in the world is it doing all the way down here?")}
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "What do you have there, Abhai?")}
                {SPEAKER_GENERIC (speaker=Abhai) ( _ "This is the Great Rod of Justice, my boy. It was an ancient artifact even when I was young. They say it was crafted by the Great Gods themselves, and given to the first true Ruler of Men to ensure peace, harmony and above all — justice. For hundreds of years it did just that, for during the time it was wielded by men, the ruling class never became corrupt, the people never lacked justice and neither evil nor wars troubled the land.")}
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Well, if you don’t mind me saying — that certainly isn’t the state of affairs now. Knalga lies in ruins, orcs ravage the surface, and these dark and evil creatures haunt the underground passages. In the meantime, Wesnoth is said to be ruled by the wicked and cruel queen Asheviere, while the rightful heir must have long since perished in his vain quest for the Scepter of Fire.")}
                {SPEAKER_GENERIC (speaker=Abhai) ( _ "Ahh, with the Rod of Justice down here it is to be expected. Come Tallin, either you or one of your trusted men must wield this staff and bring peace and justice back into this world.")}
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Why can’t you wield it, Abhai?")}
                {SPEAKER_GENERIC (speaker=Abhai) ( _ "I am a creature of the past, and thus my time to wield it is long gone. This is your era, Tallin, and thus it is your responsibility to see to it that your people receive peace, prosperity and justice. Quickly, come forth or send one of your men for time is waning.")}
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Very well.")}
            [/then]
            [/if]
        [/event]

        [event]
            first_time_only=no
            name=moveto

            [filter]
                side=1
                x,y={X},{Y}
                [not]
                    id=Abhai
                [/not]
            [/filter]
            [if]
                [variable]
                    name=got_rod_of_justice
                    less_than=1
                [/variable]
            [then]
                [message]
                    speaker=narrator
                    caption= _ "Rod of Justice"
                    image=items/staff.png
                    message= _ "<span color='#fff21f'>Properties:
16-4 fire ranged attack, +2 melee damage, +10 hitpoints, +2 movement, +20% faster advancing</span>

Should I pick up the Rod of Justice?"
                    [option]
                        message= _ "rod of justice^Take it"
                        [command]
                            {SPEAKER_GENERIC (speaker=unit) ( _ "Wow! This thing is... incredible!")}
                            {SPEAKER_GENERIC (speaker=unit) ( _ "I wonder what such a powerful artifact is doing hidden all the way back here...")}
                            [if]
                                [have_unit]
                                    id=Camerin
                                [/have_unit]
                            [then]
                                {SPEAKER_GENERIC (speaker=Camerin) ( _ "That’s... that’s the Rod of Justice!")}
                                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Do you know anything about it, Camerin?")}
                                {SPEAKER_GENERIC (speaker=Camerin) (_ "I don’t think there is a person alive who knows anything more solid than rumors and legends. There are very few people who even knows it exists!")}
                                {SPEAKER_GENERIC (speaker=Tallin) ( _ "How did you come to know of it?")}
                                {SPEAKER_GENERIC (speaker=Camerin) ( _ "Some of the most ancient elvish legends make some vague mention of this artifact. But beyond that...")}
                                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Interesting. I wonder who — or what — could have created such a powerful artifact. There must be one heck of a story behind this thing.")}
                            [/then]
                            [/if]
                            # Remove the icon
                            [remove_item]
                                x={X}
                                y={Y}
                            [/remove_item]
                            # Apply the effects
                            {ROD_OF_JUSTICE $unit.id no}
                            {VARIABLE got_rod_of_justice 1}

                            # This is needed since we will not simply transform unit in Old Friend scenario
                            [if]
                                [variable]
                                    name=unit.id
                                    equals=Tallin
                                [/variable]
                            [then]
                                {VARIABLE leader_has_rod 1}
                            [/then]
                            [/if]
                        [/command]
                    [/option]
                    [option]
                        message= _ "rod of justice^Leave it"
                        [command]
                            [allow_undo][/allow_undo]
                        [/command]
                    [/option]
                [/message]
            [/then]
            [/if]
        [/event]
    #enddef

    #define TREASURE_BONES X Y AREA_X AREA_Y BONES
        {PUT_BONES 1 {X} {Y}}
        {VARIABLE cell_bones {BONES}}

        [event]
            name=moveto

            [filter]
                side=1
                x={AREA_X}
                y={AREA_Y}
            [/filter]

            [store_unit]
                [filter]
                    id=$unit.id
                [/filter]
                kill=yes
                variable=assaulter
            [/store_unit]

            {VARIABLE assaulter.moves 0}

            [unstore_unit]
                variable=assaulter
            [/unstore_unit]

            {CLEAR_VARIABLE assaulter}

            {SPEAKER_GENERIC (speaker=unit) ( _ "That was a mighty warrior in his time... Hey!")}

            {BONES_ENCOUNTER {X} {Y}}
        [/event]
    #enddef

    #define TREASURE_GOLD X Y AREA_X AREA_Y
        {PUT_BONES 0 {X} {Y}}

        [event]
            name=moveto

            [filter]
                side=1
                x={AREA_X}
                y={AREA_Y}
            [/filter]

            {SPEAKER_GENERIC (speaker=unit) ( _ "He had 50 gold pieces but it seemed that it didn't help him much...")}

            [gold]
    	        side=1
	            amount=52
            [/gold]

            {REMOVE_TERRAIN_OBJECT {X} {Y}}
        [/event]
    #enddef

    #define TREASURE_DUST X Y AREA_X AREA_Y
        {PUT_BONES 0 {X} {Y}}

        [event]
            name=moveto

            [filter]
                side=1
                x={AREA_X}
                y={AREA_Y}
            [/filter]

            {SPEAKER_GENERIC (speaker=unit) ( _ "Nothing but a dusted pile of bones.")}
            {REMOVE_TERRAIN_OBJECT {X} {Y}}
        [/event]
    #enddef

    #define PUT_TREASURE PILE_NUMBER_MIN PILE_NUMBER_MAX FIND TREASURE_WML
        [if]
            [variable]
                name=pile_free
                greater_than=0
            [/variable]
        [then]
            {RANDOM {PILE_NUMBER_MIN}..{PILE_NUMBER_MAX}}
            {VARIABLE treasure_pile $random}
        [/then]
        [else]
            {VARIABLE treasure_pile 0}
        [/else]
        [/if]

        {VARIABLE pile[{FIND}] $pile_location[$treasure_pile]}

        [if]
            [variable]
                name=treasure_pile
                less_than=$pile_free
            [/variable]
        [then]
            {VARIABLE pile_location[$treasure_pile] $pile_location[$pile_free]}
        [/then]
        [/if]

        {CLEAR_VARIABLE pile_location[$pile_free]}
        {CLEAR_VARIABLE random}

        {VARIABLE_OP pile_free sub 1}

        {TREASURE_WML}
    #enddef

    #define HAUNTED_TUNNEL WATER_X WATER_Y TUNNEL_X TUNNEL_Y X Y
        [terrain]
            x={WATER_X}
            y={WATER_Y}
            terrain=Ww
        [/terrain]

        [event]
            name=moveto
            [filter]
                side=1
                x={TUNNEL_X}
                y={TUNNEL_Y}
            [/filter]

            {SPEAKER_GENERIC (speaker=unit) ( _ "Hmm, what is this thing?")}
            {UNIT 1 "Wraith" {X} {Y} (
                [modifications]
                    {TRAIT_UNDEAD}
                    {TRAIT_LOYAL}
                    {TRAIT_INTELLIGENT}
                [/modifications]
                {IS_LOYAL}
                id=Abhai
                name= _ "Abhai"
                unrenamable=yes
                #profile=Abhai.png
            )}
            # wmllint: no spellcheck
            {SPEAKER_GENERIC (speaker=Abhai) ( _ "EEEEEE!")}
            # wmllint: no spellcheck
            {SPEAKER_GENERIC (speaker=unit) ( _ "AHHHH!")}
            {SPEAKER_GENERIC (speaker=Abhai) ( _ "... Wait a second, who are you?")}
            {SPEAKER_GENERIC (speaker=unit) ( _ "I... I am one of Tallin’s men...")}
            {SPEAKER_GENERIC (speaker=Abhai) ( _ "Who is this ‘Tallin’?")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "I am.")}
            {SPEAKER_GENERIC (speaker=Abhai) ( _ "What is your purpose in coming here?")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "We seek the lich Malifor.")}
            {SPEAKER_GENERIC (speaker=Abhai) ( _ "Malifor...! (<i>Goes a bit paler (if possible)</i>) What business do you have with him?")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "We seek to crush and destroy him.")}
            # wmllint: local spellings Kalian Hiera'Shirsha
            {SPEAKER_GENERIC (speaker=Abhai) ( _ "Oh, thank the Gods of Light! Finally there is someone here in force to deal with that menace. You must have been sent by the High Kalian of Hiera’Shirsha?")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "The what?")}
            {SPEAKER_GENERIC (speaker=Camerin) ( _ "Err, I think we might be in different... uh... time zones, here.")}
            {SPEAKER_GENERIC (speaker=Abhai) ( _ "I beg your pardon. Say, what year is it anyway?")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "Uh... 534...")}
            {SPEAKER_GENERIC (speaker=Abhai) ( _ "Huh?! Can’t be, the last year I remember it was 14,318AD!")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "?")}
            {SPEAKER_GENERIC (speaker=Camerin) ( _ "Different calendars, folks.")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "I see, but say, who are you?")}
            {SPEAKER_GENERIC (speaker=Abhai) ( _ "What? How can you not know who I am?")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "The times have changed, my friend.")}
            # wmllint: local spelling Garet-Desh
            {SPEAKER_GENERIC (speaker=Abhai) ( _ "Right... sorry about that. My name is Lord Abhai and I am... or was... the ruler of the great kingdom of Garet-Desh.")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "What happened to you? Why are you a ghost?")}
             # wmllint: local spelling ectoplasmic
            {SPEAKER_GENERIC (speaker=Abhai) ( _ "I grew old and died as all men do and entered the land of the dead. I don’t know how long I dwelt there, I was wrenched from my peace and forced into this ectoplasmic body by a terrible power.")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "Let me guess. Malifor?")}
            {SPEAKER_GENERIC (speaker=Abhai) ( _ "Indeed. He tried to break my spirit into mindless slavery, but I resisted his power and fled. I have been hiding in these flooded tunnels ever since. Some monster that Malifor’s minions greatly fear lives in these waters; they do not molest me here.")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "Would you join us to defeat this evil creature?")}
            # wmllint: local spelling er
            {SPEAKER_GENERIC (speaker=Abhai) ( _ "Wouldn’t miss it. Maybe after he is destroyed me and my kind can live... er... be dead peacefully.")}
            {SPEAKER_GENERIC (speaker=Abhai) ( _ "Keep following these flooded tunnels. I think they might lead you directly to Malifor.")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "Great! Forward, men!")}
        [/event]
    #enddef

    #define MALIFOR_MAGE_SPEAK
        [if]
            [variable]
                name=malifor_mage_speak
                less_than=1
            [/variable]
            [and]
                [have_unit]
                    side=1
                    id=Father Morvin
                [/have_unit]
                [or]
                    [have_unit]
                        side=1
                        id=Sister Thera
                    [/have_unit]
                [/or]
            [/and]
        [then]
            {SPEAKER_GENERIC (speaker=Malifor) ( _ "So, you have joined forces with those pathetic mages... In contrast to what you might think of them, they are not invincible. I assure you that <i>MY</i> troops can put their miserable life to an end!")}

            {VARIABLE malifor_mage_speak 1}
        [/then]
        [/if]
    #enddef

    #define CONFRONTATION_PURSUIT
        [if]
            [variable]
                name=malifor_mage_speak
                numerical_equals=1
            [/variable]
        [then]
            [message]
                speaker=narrator
                message= _ "White mages can be killed only by Malifor (<span color='#0090ff'>blue</span>) units."
                image=wesnoth-icon.png
            [/message]

            {OBJECTIVES_PURSUIT ( _ "Find Malifor and destroy him") (
                [objective]
                    description= _ "Death of Father Morvin"
                    condition=lose
                [/objective]
                [objective]
                    description= _ "Death of Sister Thera"
                    condition=lose
                [/objective]
            )}

            {VARIABLE malifor_mage_speak 2}
        [/then]
        [/if]
    #enddef

    #define MALIFOR_CONFRONTATION
        # Now opening the door will trigger the confrontation with Malifor if it didn't happen yet.
        [if]
            [variable]
                name=confronted_malifor
                less_than=1
            [/variable]
        [then]
            # Set a flag to prevent the confrontation form getting triggered more than once
            {VARIABLE confronted_malifor 1}
            [redraw]
                side=1
            [/redraw]
            {SPEAKER_GENERIC (speaker=Malifor) ( _ "You wretched vermin, I have had it with you! Guards!")}
            # Give malifor 4 guards and 150 gold at Newbie
            {GENERIC_UNIT 4 Deathblade 29 15}
            {GENERIC_UNIT 4 Deathblade 31 15}
            {GENERIC_UNIT 4 Lich 29 14}
            {GENERIC_UNIT 4 Lich 31 14}
            [modify_side]
                side=4
                {GOLD4 150 200 300 400}
                recruit=Deathblade,Revenant,Bone Shooter,Necromancer
            [/modify_side]
            # 6 guards and 200 gold at Easy
            #ifndef EASY
                {GENERIC_UNIT 4 Deathblade 32 14}
                {GENERIC_UNIT 4 Lich 28 14}
            # 8 guards and 300 gold at Normal
            #ifndef NORMAL
                {GENERIC_UNIT 4 Deathblade 28 15}
                {GENERIC_UNIT 4 Lich 32 15}
            # 10 guards and 400 gold at Hard
            #ifndef HARD
                {GENERIC_UNIT 4 Deathblade 31 16}
                {GENERIC_UNIT 4 Lich 29 16}
            #endif
            #endif
            #endif

            {SPEAKER_GENERIC (speaker=Malifor) ( _ "You invaded my kingdom, drove me from my mines, raided my dungeon, and plundered my treasury. Your audacity ends here!")}
            # Second Malifor line doesn't make sense without at least one White Mage around, for this reason we need
            # to check for their presence.  I'm not assuming that they might have died, but they might not have been freed at this point.
            [if]
                [have_unit]
                    id=Father Morvin
                [/have_unit]
                [or]
                    [have_unit]
                        id=Sister Thera
                    [/have_unit]
                [/or]
            [then]
                {SPEAKER_GENERIC (speaker=Father Morvin) ( _ "You are wrong, Malifor, for you shall be the one who is destroyed. You are cruel, merciless and a terror to all that lives. The world will be a better place with you gone!")}
                {SPEAKER_GENERIC (speaker=Sister Thera) ( _ "To feed your greed and hunger you have terrorized all that is good. You have disturbed the rest of the brave defenders of Knalga. Now, your evil reign shall be brought to an end.")}
                {MALIFOR_MAGE_SPEAK}
            [/then]
            [else]
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Ye, ye we heard that before.")}
            [/else]
            [/if]

            {SPEAKER_GENERIC (speaker=Malifor) ( _ "Fools! Don’t think it’s so easy to kill me. Your corpses shall all soon be serving me. Fall on them, my hordes!")}
            {ORDER_ATTACK 5 0}
            {ORDER_ATTACK 6 1}
            {CONFRONTATION_PURSUIT}
        [/then]
        [/if]
    #enddef

    #define UNDEAD_WARRIORS
        #ifdef EASY
            recruit=Skeleton,Skeleton Archer
        #endif

        #ifdef NORMAL
            recruit=Skeleton,Skeleton Archer,Revenant
        #endif

        #ifdef HARD
            recruit=Skeleton,Skeleton Archer,Revenant,Bone Shooter
        #endif

        #ifdef NIGHTMARE
            recruit=Skeleton,Skeleton Archer,Revenant,Bone Shooter,Deathblade
        #endif
    #enddef

    #define UNDEAD_TROOPS_LIGHT SIDE
        #ifdef NORMAL
            {LIMIT_CONTEMPORANEOUS_RECRUITS {SIDE} "Revenant" 2}
        #endif

        #ifdef HARD
            {LIMIT_CONTEMPORANEOUS_RECRUITS {SIDE} "Revenant" 2}
            {LIMIT_CONTEMPORANEOUS_RECRUITS {SIDE} "Bone Shooter" 2}
        #endif

        #ifdef NIGHTMARE
            {LIMIT_CONTEMPORANEOUS_RECRUITS {SIDE} "Revenant" 2}
            {LIMIT_CONTEMPORANEOUS_RECRUITS {SIDE} "Bone Shooter" 3}
            {LIMIT_CONTEMPORANEOUS_RECRUITS {SIDE} "Deathblade" 3}
        #endif
    #enddef

    #define UNDEAD_TROOPS_HEAVY SIDE
        #ifdef NORMAL
            {LIMIT_CONTEMPORANEOUS_RECRUITS {SIDE} "Revenant" 8}
        #endif

        #ifdef HARD
            {LIMIT_CONTEMPORANEOUS_RECRUITS {SIDE} "Revenant" 8}
            {LIMIT_CONTEMPORANEOUS_RECRUITS {SIDE} "Bone Shooter" 8}
        #endif

        #ifdef NIGHTMARE
            {LIMIT_CONTEMPORANEOUS_RECRUITS {SIDE} "Revenant" 8}
            {LIMIT_CONTEMPORANEOUS_RECRUITS {SIDE} "Bone Shooter" 8}
            {LIMIT_CONTEMPORANEOUS_RECRUITS {SIDE} "Deathblade" 8}
        #endif
    #enddef

    #define MOBILIZE_DUNGEON
        [if]
            [variable]
                name=mobilize_undead[0]
                less_than=1
            [/variable]
        [then]
            {VARIABLE mobilize_undead[0] 1}
            {SPEAKER_GENERIC (speaker=Tervor) ( _ "They are trying to free the prisoners! Stop them!")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "Good luck, my friend.")}
            [modify_side]
                side=7
                {GOLD4 100 200 350 500}
                {UNDEAD_WARRIORS}
            [/modify_side]

            #ifdef NORMAL
                {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Revenant" 3}
            #endif

            #ifdef HARD
                {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Revenant" 3}
                {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Bone Shooter" 3}
            #endif

            #ifdef NIGHTMARE
                {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Revenant" 3}
                {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Bone Shooter" 3}
                {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Deathblade" 4}
            #endif

            {ORDER_ATTACK 5 0}
            {ORDER_ATTACK 6 1}
        [/then]
        [/if]
    #enddef

    #define MOBILIZE_TREASURY INTRUDER
        [if]
            [variable]
                name=mobilize_undead[1]
                less_than=1
            [/variable]
        [then]
            {VARIABLE mobilize_undead[1] 1}
            {SPEAKER_GENERIC (id=Treasury Chieftain) ( _ "Intruders! Get them!")}
            {SPEAKER_GENERIC {INTRUDER} ( _ "Bring it on!")}
            [modify_side]
                side=8
                {GOLD4 200 400 700 1000}
                {UNDEAD_WARRIORS}
            [/modify_side]

            {UNDEAD_TROOPS_HEAVY 8}
            {ORDER_ATTACK 5 0}
            {ORDER_ATTACK 6 1}

            [event]
                name=side 8 turn
                first_time_only=no

                [if]
                    [variable]
                        name=mobilize_undead[1]
                        less_than=2
                    [/variable]
                [then]
                    {VARIABLE mobilize_undead[1] 2}
                [/then]
                [else]
                    [if]
                        [variable]
                            name=mobilize_undead[1]
                            less_than=3
                        [/variable]
                    [then]
                        [store_unit]
                            [filter]
                                side=1
                                x=10-12,11
                                y=21-26,27
                            [/filter]
                            kill=no
                            variable=assaulters
                        [/store_unit]

                        [if]
                            [variable]
                                name=assaulters[2].x
                                greater_than=0
                            [/variable]
                        [then]
                            [sound]
                                name=melee-fire.ogg
                            [/sound]
                            {OPEN_DWARVEN_DOOR (14,15) (26,27)}
                            [redraw]
                                side=1
                            [/redraw]
                        [/then]
                        [/if]

                        {VARIABLE mobilize_undead[1] 3}

                        {CLEAR_VARIABLE assaulters}
                    [/then]
                    [/if]
                [/else]
                [/if]
            [/event]
        [/then]
        [/if]
    #enddef

    #define MOBILIZE_STUDY UNIT
        [if]
            [variable]
                name=mobilize_undead[2]
                less_than=1
            [/variable]
        [then]
            {VARIABLE mobilize_undead[2] 1}
            {SPEAKER_GENERIC (role=Study Guard) ( _ "They are attacking the master’s study! We must stop them! Call the reserves!")}
            {SPEAKER_GENERIC (speaker={UNIT}) ( _ "‘The master’s study’ eh? I bet we’ll find Malifor there!")}
            [modify_side]
                side=9
                {GOLD4 200 400 700 1000}
                {UNDEAD_WARRIORS}
            [/modify_side]

            {UNDEAD_TROOPS_HEAVY 9}
            {ORDER_ATTACK 5 0}
            {ORDER_ATTACK 6 1}
        [/then]
        [/if]
    #enddef

    #define GATE_ASSAULTS ASSAULT1 ASSAULT2
        [variable]
            name=assaults[0]
            {ASSAULT1}
        [/variable]
        [and]
             [variable]
                 name=assaults[1]
                 {ASSAULT2}
             [/variable]
        [/and]
    #enddef

    #define SPEAKER_ASSAULTER MESSAGE
        [if]
            [variable]
                name=assaulters[0].id
                not_equals=Tallin
            [/variable]
        [then]
            {SPEAKER_GENERIC (id=$assaulters[0].id) {MESSAGE}}
        [/then]
        [else]
            {SPEAKER_GENERIC (role=Supporter) {MESSAGE}}
        [/else]
        [/if]
    #enddef

    #define FORCE_UNDEAD SIDE1_VARIABLE SIDE2_VARIABLE
        [variable]
            name=forces_undead[{SIDE1_VARIABLE}]
            greater_than=3
        [/variable]
        [and]
            [variable]
                name=forces_undead[{SIDE2_VARIABLE}]
                greater_than=3
            [/variable]
        [/and]
    #enddef

    #define BEHOLDER_GATE SIDE TROOPS GATE X Y THREAT_X THREAT_Y HALL_X HALL_Y TROOPS_X TROOPS_Y
        [if]
            [have_unit]
                side={SIDE}
                canrecruit=yes
            [/have_unit]
        [then]
            [if]
                [variable]
                    name=beholder_gate[{GATE}]
                    greater_than=0
                [/variable]
            [then]
                [if]
                    [variable]
                        name=beholder_gate_lock[{GATE}]
                        greater_than=0
                    [/variable]
                [then]
                    {VARIABLE_OP beholder_gate_lock[{GATE}] sub 1}
                [/then]
                [/if]

                [if]
                    [variable]
                        name=order_attack[{GATE}]
                        less_than=1
                    [/variable]
                    [and]
                        [variable]
                            name=beholder_gate_lock[{GATE}]
                            less_than=1
                        [/variable]
                    [/and]
                [then]
                    [sound]
                        name=melee-fire.ogg
                    [/sound]
                    {OPEN_DWARVEN_DOOR {X} {Y}}
                    [redraw]
                        side=1
                    [/redraw]
                    {VARIABLE beholder_gate[{GATE}] 0}
                    {VARIABLE beholder_gate_lock[{GATE}] 3}

                    [if]
                        [variable]
                            name={TROOPS}[0].x
                            greater_than=0
                        [/variable]
                    [then]
                        [unstore_unit]
                            variable={TROOPS}
                        [/unstore_unit]

                        {CLEAR_VARIABLE {TROOPS}}
                    [/then]
                    [/if]

                    {MODIFY_AI_DELETE_GOAL {SIDE} assembly_troops}
                [/then]
                [/if]
            [/then]
            [else]
                [if]
                    [not]
                        [variable]
                            name=confonted_malifor
                            greater_than=0
                        [/variable]
                        [or]
                            {FORCE_UNDEAD 7 8}
                        [/or]
                        [or]
                            {FORCE_UNDEAD 8 9}
                        [/or]
                        [or]
                            {FORCE_UNDEAD 7 9}
                        [/or]
                    [/not]
                [then]
                    [if]
                        [variable]
                            name=beholder_gate_lock[{GATE}]
                            less_than=1
                        [/variable]
                    [then]
                        [if]
                            [variable]
                                name=forces_undead[{GATE}]
                                less_than=4
                            [/variable]
                        [then]
                            [store_unit]
                                [filter]
                                    side=1
                                    x={THREAT_X}
                                    y={THREAT_Y}
                                [/filter]
                                kill=no
                                variable=assaulters
                            [/store_unit]
                            [store_unit]
                                [filter]
                                    side=1
                                    x={HALL_X}
                                    y={HALL_Y}
                                [/filter]
                                kill=no
                                variable=conquerors
                            [/store_unit]

                            [if]
                                [variable]
                                    name=assaulters[0].x
                                    greater_than=0
                                [/variable]
                                [and]
                                    [variable]
                                        name=conquerors[0].x
                                        less_than=1
                                    [/variable]
                                [/and]
                            [then]
                                [store_unit]
                                    [filter]
                                        side=2,3,5,6,7,8,9
                                        x={X}
                                        y={Y}
                                    [/filter]
                                    kill=yes
                                    variable={TROOPS}
                                [/store_unit]

                                [if]
                                    [variable]
                                        name={TROOPS}[0].x
                                        greater_than=0
                                    [/variable]
                                [then]
                                    {VARIABLE {TROOPS}[0].hitpoints ${TROOPS}[0].max_hitpoints}
                                    {VARIABLE {TROOPS}[0].moves ${TROOPS}[0].max_moves}
                                    {VARIABLE {TROOPS}[0].attacks_left 1}

                                    [if]
                                        [variable]
                                            name={TROOPS}[1].x
                                            greater_than=0
                                        [/variable]
                                    [then]
                                        {VARIABLE {TROOPS}[1].hitpoints ${TROOPS}[1].max_hitpoints}
                                        {VARIABLE {TROOPS}[1].moves ${TROOPS}[1].max_moves}
                                        {VARIABLE {TROOPS}[1].attacks_left 1}
                                    [/then]
                                    [/if]
                                [/then]
                                [else]
                                    {CLEAR_VARIABLE {TROOPS}}
                                [/else]
                                [/if]

                                [sound]
                                    name=thunderstick.ogg
                                [/sound]
                                [terrain]
                                    x={X}
                                    y={Y}
                                    terrain=Xu
                                [/terrain]
                                [redraw]
                                    side=1
                                [/redraw]

                                {VARIABLE order_attack[{GATE}] 1}
                                {VARIABLE beholder_gate[{GATE}] 1}
                                {VARIABLE beholder_gate_lock[{GATE}] 4}

                                {VARIABLE_OP assaults[{GATE}] add 1}
                                {VARIABLE_OP assaults[2] add 1}

                                {MODIFY_AI_ADD_GOAL {SIDE} (
                                    [goal]
                                        name=target_location
                                        id=assembly_troops
                                        [criteria]
                                            x={TROOPS_X}
                                            y={TROOPS_Y}
                                        [/criteria]
                                        value=5
                                    [/goal]
                                )}

                                [if]
                                    {GATE_ASSAULTS less_than=2 less_than=1}
                                    [or]
                                        {GATE_ASSAULTS less_than=1 less_than=2}
                                    [/or]
                                [then]
                                    {SPEAKER_ASSAULTER ( _ "They sealed the gates! We can't get through!")}
                                    {SPEAKER_GENERIC (speaker=Tallin) ( _ "Fine! You may rot in your tomb skellies!")}
                                    {SPEAKER_GENERIC (role=Supporter) ( _ "I don't think this is over yet. Maybe they wait for a better chance to attack?")}
                                [/then]
                                [else]
                                    [if]
                                        {GATE_ASSAULTS numerical_equals=1 numerical_equals=1}
                                    [then]
                                        {SPEAKER_ASSAULTER ( _ "They've locked this gates too!")}
                                    [/then]
                                    [else]
                                        [if]
                                            [variable]
                                                name=assaults[2]
                                                greater_than=5
                                            [/variable]
                                        [then]
                                            {SPEAKER_ASSAULTER ( _ "I'm tired of chasing them time and again. Why don't we just do what we came for?")}
                                        [/then]
                                        [else]
                                            [if]
                                                [variable]
                                                    name=mauler_dwarf
                                                    less_than=1
                                                [/variable]
                                                [and]
                                                    [variable]
                                                        name=assaulters[0].type
                                                        equals=Dwarvish Fighter
                                                    [/variable]
                                                    [or]
                                                        [variable]
                                                            name=assaulters[0].type
                                                            equals=Dwarvish Steelclad
                                                        [/variable]
                                                    [/or]
                                                    [or]
                                                        [variable]
                                                            name=assaulters[0].type
                                                            equals=Dwarvish Lord
                                                        [/variable]
                                                    [/or]
                                                [/and]
                                            [then]
                                                {RANDOM 0..1}

                                                [switch]
                                                    variable=random
                                                    [case]
                                                        value="0"
                                                        {SPEAKER_GENERIC (id=$assaulter[0].id) ( _ "And you think that locking yourself in there makes you lvm or somethin'? Come out here and you will see how lucky versus mauling you really are!")}
                                                    [/case]
                                                    [else]
                                                        {SPEAKER_GENERIC (id=$assaulter[0].id) ( _ "Scary, scary of my axe you should be wary.")}
                                                    [/else]
                                                [/switch]

                                                {VARIABLE mauler_dwarf 1}
                                            [/then]
                                            [else]
                                                [if]
                                                    [variable]
                                                        name=taunt_free
                                                        greater_than=0
                                                    [/variable]
                                                [then]
                                                    {RANDOM 0..$taunt_free}
                                                    {VARIABLE taunt_form $random}
                                                [/then]
                                                [else]
                                                    {VARIABLE taunt_form 0}
                                                [/else]
                                                [/if]

                                                {VARIABLE taunt $taunt_speak[$taunt_form]}
                                                {CLEAR_VARIABLE random}

                                                [if]
                                                    [variable]
                                                        name=taunt_form
                                                        less_than=$cell_free
                                                    [/variable]
                                                [then]
                                                    {VARIABLE taunt_speak[$taunt_form] $taunt_speak[$taunt_free]}
                                                [/then]
                                                [/if]

                                                [switch]
                                                    variable=taunt
                                                    [case]
                                                        value="0"
                                                        {SPEAKER_ASSAULTER ( _ "And stay there if you know what's best for you!")}
                                                    [/case]
                                                    [case]
                                                        value="1"
                                                        {SPEAKER_ASSAULTER ( _ "I hear your bones rattling... In fear!")}
                                                    [/case]
                                                    [case]
                                                        value="2"
                                                        {SPEAKER_ASSAULTER ( _ "Ye! And don't dare to come out again!")}
                                                    [/case]
                                                    [else]
                                                        {SPEAKER_ASSAULTER ( _ "These doors won't protect you forever, coward!")}
                                                    [/else]
                                                [/switch]

                                                {CLEAR_VARIABLE taunt_speak[$taunt_free]}
                                                {CLEAR_VARIABLE taunt_form}
                                                {CLEAR_VARIABLE taunt}

                                                {VARIABLE_OP taunt_free sub 1}
                                            [/else]
                                            [/if]
                                        [/else]
                                        [/if]
                                    [/else]
                                    [/if]
                                [/else]
                                [/if]
                            [/then]
                            [/if]

                            {CLEAR_VARIABLE assaulters}
                            {CLEAR_VARIABLE conquerors}
                        [/then]
                        [/if]
                    [/then]
                    [else]
                        [if]
                            [variable]
                                name=beholder_gate_lock[{GATE}]
                                greater_than=0
                            [/variable]
                        [then]
                            {VARIABLE_OP beholder_gate_lock[{GATE}] sub 1}
                        [/then]
                        [/if]
                    [/else]
                    [/if]
                [/then]
                [/if]
            [/else]
            [/if]
        [/then]
        [/if]
    #enddef

    #define BEGIN_PURSUIT
        {SPEAKER_GENERIC (speaker=Tallin) ( _ "Blast it! We lost him.")}
        {SPEAKER_GENERIC (speaker=Tallin) ( _ "It makes no difference in the end, because we will hunt him down and crush him to powder. HEAR THAT, YOU OLD SKELETON?")}
        {SPEAKER_GENERIC (speaker=Malifor) ( _ "(<i>Faint cackle of laughter in the distance</i>)")}
        {SPEAKER_GENERIC (speaker=Camerin) ( _ "Yeah! This is gonna be fun!")}
        {SPEAKER_GENERIC (speaker=Tallin) ( _ "Let us proceed with caution. Nobody is to go off by himself. We don’t know what could be lurking in these tunnels.")}
        {OBJECTIVES_PURSUIT ( _ "Find Malifor and destroy him") ()}
    #enddef

    # Players side
    [side]
        {PROTAGONIST_FORCES}
        {GOLD4 700 600 400 300}
        recruit=Peasant,Woodsman,Thug,Poacher,Footpad
        user_team_name=_"Knalgans"
        shroud=yes
    [/side]

    [side]
        no_leader=yes
        side=2
        team_name=foe
        user_team_name={S_MONSTERS}
        hidden=yes
        gold=0
        [ai]
            village_value=0.0
            aggression=1.0
        [/ai]
        color=green
    [/side]

    [side]
        no_leader=yes
        side=3
        team_name=foe
        user_team_name={S_UNDEAD}
        gold=0
        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            [engine]
                name="lua"
                code= <<
                    ai_guardians = ...
                    return wesnoth.require "~add-ons/Northern_Rebirth_Remake/lua/guardians_engine.lua"
                >>
            [/engine]
        [/ai]
        [ai]
            {MODIFY_AI_ADD_CANDIDATE_ACTION 1 main_loop (
                [candidate_action]
                    engine=fai
                    name=go_home
                    type=movement
                    evaluation="if( (null != me.vars.home_loc), {AI_CA_MOVE_TO_TARGETS_SCORE}+10, 0)"
                    action="if( (me.loc != me.vars.home_loc), move(me.loc, next_hop(me.loc, me.vars.home_loc)), move(me.loc, me.loc)#do not move this turn#)"
                [/candidate_action]
            )}
        [/ai]
        color=white
    [/side]
    # Main enemy
    [side]
        type=Ancient Lich
        id=Malifor
        name= _ "Malifor"
        profile=portraits/Malifor.png
        canrecruit=yes
        side=4
        team_name=foe
        user_team_name={S_UNDEAD}
        {MALIFOR_ABILITIES}
        hidden=yes
        gold=0
        [ai]
            aggression=1.0
            [goal]
                id=Sister Thera
                value=10
            [/goal]
            [goal]
                id=Father Morvin
                value=10
            [/goal]
            [aspect]
                id=attacks
                [facet]
                    invalidate_on_gamestate_change=yes
                    [filter_own]
                        type=Ancient Lich
                    [/filter_own]
                    [filter_enemy]
                        [not]
                            type=White Mage,Mage of Light
                        [/not]
                    [/filter_enemy]
                [/facet]
                [facet]
                    invalidate_on_gamestate_change=yes
                    [filter_own]
                        side=4
                    [/filter_own]
                    [filter_enemy]
                        side=1
                    [/filter_enemy]
                [/facet]
            [/aspect]
        [/ai]
        {FLAG_VARIANT undead}
        color=blue
    [/side]
    # Enemies to the immediate left and right of the first chamber
    [side]
        type=Death Knight
        id=Hettel
        name=_ "Hettel"
        canrecruit=yes
        side=5
        team_name=foe
        user_team_name={S_UNDEAD}
        hidden=yes
        {GOLD4 50 100 150 250}
        {INCOME4 4 10 16 22}
        {UNDEAD_WARRIORS}
        {AI_UNDEAD}
        {FLAG_VARIANT undead}
    [/side]

    [side]
        type=Death Knight
        id=Thar
        name= _ "Thar"
        canrecruit=yes
        side=6
        team_name=foe
        user_team_name={S_UNDEAD}
        hidden=yes
        {GOLD4 50 100 150 250}
        {INCOME4 4 10 16 22}
        {UNDEAD_WARRIORS}
        {AI_UNDEAD}
        {FLAG_VARIANT undead}
    [/side]
    # Dungeon guard
    [side]
        type=Death Knight
        id=Tervor
        name=_ "Tervor"
        canrecruit=yes
        side=7
        team_name=foe
        user_team_name={S_UNDEAD}
        hidden=yes
        gold=0
        {AI_UNDEAD}
        {FLAG_VARIANT undead}
    [/side]
    # Treasury guards
    [side]
        type=Death Knight
        id=Antrasis
        name=_ "Antrasis"
        canrecruit=yes
        side=8
        team_name=foe
        user_team_name={S_UNDEAD}
        hidden=yes
        gold=0
        {AI_UNDEAD}
        {FLAG_VARIANT undead}
        color=purple
    [/side]

    [side]
        type=Death Knight
        id=Samlan
        name=_ "Samlan"
        canrecruit=yes
        side=9
        team_name=foe
        user_team_name={S_UNDEAD}
        hidden=yes
        gold=0
        {AI_UNDEAD}
        {FLAG_VARIANT undead}
    [/side]

    [event]
        name=prestart

        {TEAM_COLOR_OVERRIDE id=Malifor red}
        # Place images
        # Whole lot of doors
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 14 26}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 15 27}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 11 38}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 9 37}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 10 34}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 6 32}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 7 25}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 20 20}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 17 12}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 18 11}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 22 11}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 23 12}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 31 40}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 31 37}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 28 17}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 29 18}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 31 18}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 32 17}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 27 13}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 33 13}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 9 29}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 9 30}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 25 37}
        {PLACE_IMAGE scenery/dwarven-doors-closed.png 26 36}
        # Stone markers
        {PLACE_IMAGE scenery/monolith2.png 16 31}
        {PLACE_IMAGE scenery/monolith2.png 17 30}
        {PLACE_IMAGE scenery/monolith2.png 20 29}
        {PLACE_IMAGE scenery/monolith2.png 23 30}
        {PLACE_IMAGE scenery/monolith2.png 24 31}
        {PLACE_IMAGE scenery/rune4.png 10 18}
        {PLACE_IMAGE scenery/rune2.png 20 22}
        {PLACE_IMAGE scenery/rune2.png 20 25}
        {PLACE_IMAGE scenery/rune5.png 30 19}
        # Treasury chests
        {PLACE_IMAGE items/chest.png 6 20}
        {PLACE_IMAGE items/chest.png 8 20}
        {PLACE_IMAGE items/chest.png 5 19}
        {PLACE_IMAGE items/chest.png 7 17}
        {PLACE_IMAGE items/chest.png 11 16}
        {PLACE_IMAGE items/chest.png 10 14}

        {VARIABLE chest_free 5}
        {VARIABLE chest_location[0] 0}
        {VARIABLE chest_location[1] 1}
        {VARIABLE chest_location[2] 2}
        {VARIABLE chest_location[3] 3}
        {VARIABLE chest_location[4] 4}
        {VARIABLE chest_location[5] 5}

        {VARIABLE pile_free 3}
        {VARIABLE pile_location[0] 0}
        {VARIABLE pile_location[1] 1}
        {VARIABLE pile_location[2] 2}
        {VARIABLE pile_location[3] 3}

        {VARIABLE bones_free 3}
        {VARIABLE bones_appearance[0] 0}
        {VARIABLE bones_appearance[1] 1}
        {VARIABLE bones_appearance[2] 2}
        {VARIABLE bones_appearance[3] 3}

        {VARIABLE cell_free 4}
        {VARIABLE cell[0] 0}
        {VARIABLE cell[1] 1}
        {VARIABLE cell[2] 2}
        {VARIABLE cell[3] 3}
        {VARIABLE cell[4] 4}
        {VARIABLE cell_location[0] 0}
        {VARIABLE cell_location[1] 1}
        {VARIABLE cell_location[2] 2}

        #ifndef EASY
            {VARIABLE forces_undead[0] 0}
            {VARIABLE forces_undead[1] 0}
            {VARIABLE forces_undead[2] 0}
            {VARIABLE forces_undead[3] 0}
            {VARIABLE forces_undead[4] 0}
            {VARIABLE taunt_free 3}
            {VARIABLE taunt_speak[0] 0}
            {VARIABLE taunt_speak[1] 1}
            {VARIABLE taunt_speak[2] 2}
            {VARIABLE taunt_speak[3] 3}
        #endif

        {RANDOM 1..3}
        {VARIABLE malifor_dungeon $random}

        {PUT_GOLD_CHEST 0 5 0 10151 ( _ "10,000 gold! Wow! Where is that bag of bones getting all this?")}
        {PUT_GOLD_CHEST 0 4 1 2000 ( _ "What a hoard! 2,000 gold!")}
        {PUT_GOLD_CHEST 0 3 2 1025 ( _ "Wow! There is at least 1,000 gold in here!")}
        {PUT_GOLD_CHEST 0 2 3 800 ( _ "800 gold! We’re rich!!")}
        {PUT_GOLD_CHEST 0 1 4 510 ( _ "500 gold! Not bad!")}
        {PUT_GOLD_CHEST 0 0 5 505 ( _ "Holy Gods of Light! 500 gold!")}

        {CORPSE 38 24 ( _ "Ugh, a dead body!")}
        {CORPSE 38 9 ( _ "And another...")}
        {CORPSE 32 3 ( _ "Gee, what’s with all these bodies floating around? Is this river some sort of body disposal?")}

        [switch]
            variable=malifor_dungeon
            [case]
                value="1"
                [terrain]
                    x=6,7,4,5
                    y=23-24,23,32-33,34
                    terrain=Xu
                [/terrain]

                {AREA_STORAGE 31 36 ( _ "Ha ha, for skeletons anyway.")}
                {AREA_STORAGE 32 39 ( _ "(<i>Rolls eyes</i>) Oh, the hazardous life of a skeleton.")}
                {AREA_STORAGE_SPEAK (30,31,32,32,33,33) (35,35,35,40,39,40) 36}
                {OBJ_POTION_HOLY 30 35 object7_holywater1}
                {OBJ_POTION_HOLY 31 35 object7_holywater2}
                {OBJ_POTION_HOLY 32 35 object7_holywater3}
                {OBJ_POTION_HOLY 32 40 object7_holywater4}
                {OBJ_POTION_HOLY 33 39 object7_holywater5}
                {OBJ_POTION_HOLY 33 40 object7_holywater6}
                {DWARVEN_DOOR dungeon_door[3] 7 32 {COMMAND_DOOR dungeon_door[3] 6 32}}
                {DWARVEN_DOOR dungeon_door[4] 7 26 {COMMAND_DOOR dungeon_door[4] 7 25}}
                {DWARVEN_DOOR dungeon_door[5] 30 37 {COMMAND_DOOR_STORAGE1 dungeon_door[5] 31 37}}
                {DWARVEN_DOOR dungeon_door[6] 30 39 {COMMAND_DOOR_STORAGE2 dungeon_door[6] 31 40}}

                {VARIABLE cell_location[3] 3}
                {VARIABLE cell_location[4] 4}

                {PUT_PRISONER 0 4 0 (
                    [switch]
                        variable=captive[0]
                        [case]
                            value="0"
                            {PRISONER_KRASH 11 38 11 39 10 39 (4,5,7-8) (23-24,25,34)}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_KRASH 9 37 8 37 8 38 (4,5,7-8,9) (23-24,25,34,40)}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_KRASH 10 34 10 33 9 34 (4,5,7,9) (23-24,25,34,40)}
                        [/case]
                        [case]
                            value="3"
                            {PRISONER_KRASH 6 32 5 33 6 33 (4,5,8,9) (23-24,25,34,40)}
                        [/case]
                        [else]
                            {PRISONER_KRASH 7 25 7 24 6 24 (7-8,9) (34,40)}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 3 1 (
                    [switch]
                        variable=captive[1]
                        [case]
                            value="0"
                            {PRISONER_ELENIA 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_ELENIA 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_ELENIA 10 34 10 33}
                        [/case]
                        [case]
                            value="3"
                            {PRISONER_ELENIA 6 32 5 33}
                        [/case]
                        [else]
                            {PRISONER_ELENIA 7 25 7 24}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 2 2 (
                    [switch]
                        variable=captive[2]
                        [case]
                            value="0"
                            {PRISONER_THERA 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_THERA 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_THERA 10 34 10 33}
                        [/case]
                        [case]
                            value="3"
                            {PRISONER_THERA 6 32 5 33}
                        [/case]
                        [else]
                            {PRISONER_THERA 7 25 7 24}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 1 3 (
                    [switch]
                        variable=captive[3]
                        [case]
                            value="0"
                            {PRISONER_MORVIN 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_MORVIN 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_MORVIN 10 34 10 33}
                        [/case]
                        [case]
                            value="3"
                            {PRISONER_MORVIN 6 32 5 33}
                        [/case]
                        [else]
                            {PRISONER_MORVIN 7 25 7 24}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 0 4 (
                    [switch]
                        variable=captive[4]
                        [case]
                            value="0"
                            {PRISONER_DEAD 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_DEAD 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_DEAD 10 34 10 33}
                        [/case]
                        [case]
                            value="3"
                            {PRISONER_DEAD 6 32 5 33}
                        [/case]
                        [else]
                            {PRISONER_DEAD 7 25 7 24}
                        [/else]
                    [/switch]
                )}
            [/case]
            [case]
                value="2"
                [terrain]
                    x=6,7,30-32
                    y=23-24,23,35
                    terrain=Xu
                [/terrain]

                {AREA_STORAGE 5 33 ( _ "Ha ha, for skeletons anyway.")}
                {AREA_STORAGE 32 39 ( _ "(<i>Rolls eyes</i>) Oh, the hazardous life of a skeleton.")}
                {AREA_STORAGE_SPEAK (4,4,5,32,33,33) (32,33,34,40,39,40) 36}
                {OBJ_POTION_HOLY 4 32 object7_holywater1}
                {OBJ_POTION_HOLY 4 33 object7_holywater2}
                {OBJ_POTION_HOLY 5 34 object7_holywater3}
                {OBJ_POTION_HOLY 32 40 object7_holywater4}
                {OBJ_POTION_HOLY 33 39 object7_holywater5}
                {OBJ_POTION_HOLY 33 40 object7_holywater6}
                {DWARVEN_DOOR dungeon_door[3] 7 32 {COMMAND_DOOR_STORAGE1 dungeon_door[3] 6 32}}
                {DWARVEN_DOOR dungeon_door[4] 7 26 {COMMAND_DOOR dungeon_door[4] 7 25}}
                {DWARVEN_DOOR dungeon_door[5] 30 37 {COMMAND_DOOR dungeon_door[5] 31 37}}
                {DWARVEN_DOOR dungeon_door[6] 30 39 {COMMAND_DOOR_STORAGE2 dungeon_door[6] 31 40}}

                {VARIABLE cell_location[3] 4}
                {VARIABLE cell_location[4] 5}

                {PUT_PRISONER 0 3 0 (
                    [switch]
                        variable=captive[0]
                        [case]
                            value="0"
                            {PRISONER_KRASH 11 38 11 39 10 39 (4,5,7-8) (23-24,25,34)}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_KRASH 9 37 8 37 8 38 (4,5,7-8,9) (23-24,25,34,40)}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_KRASH 10 34 10 33 9 34 (4,5,7,9) (23-24,25,34,40)}
                        [/case]
                        [else]
                            {PRISONER_KRASH 7 25 7 24 6 24 (7-8,9) (34,40)}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 3 1 (
                    [switch]
                        variable=captive[1]
                        [case]
                            value="0"
                            {PRISONER_ELENIA 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_ELENIA 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_ELENIA 10 34 10 33}
                        [/case]
                        [case]
                            value="4"
                            {PRISONER_ELENIA 7 25 7 24}
                        [/case]
                        [else]
                            {PRISONER_ELENIA 31 37 31 36}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 2 2 (
                    [switch]
                        variable=captive[2]
                        [case]
                            value="0"
                            {PRISONER_THERA 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_THERA 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_THERA 10 34 10 33}
                        [/case]
                        [case]
                            value="4"
                            {PRISONER_THERA 7 25 7 24}
                        [/case]
                        [else]
                            {PRISONER_THERA 31 37 31 36}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 1 3 (
                    [switch]
                        variable=captive[3]
                        [case]
                            value="0"
                            {PRISONER_MORVIN 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_MORVIN 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_MORVIN 10 34 10 33}
                        [/case]
                        [case]
                            value="4"
                            {PRISONER_MORVIN 7 25 7 24}
                        [/case]
                        [else]
                            {PRISONER_MORVIN 31 37 31 36}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 0 4 (
                    [switch]
                        variable=captive[4]
                        [case]
                            value="0"
                            {PRISONER_DEAD 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_DEAD 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_DEAD 10 34 10 33}
                        [/case]
                        [case]
                            value="4"
                            {PRISONER_DEAD 7 25 7 24}
                        [/case]
                        [else]
                            {PRISONER_DEAD 31 37 31 36}
                        [/else]
                    [/switch]
                )}
            [/case]
            [case]
                value="3"
                [terrain]
                    x=6,7,33,32-33
                    y=23-24,23,39,40
                    terrain=Xu
                [/terrain]

                {AREA_STORAGE 31 36 ( _ "Ha ha, for skeletons anyway.")}
                {AREA_STORAGE 5 33 ( _ "(<i>Rolls eyes</i>) Oh, the hazardous life of a skeleton.")}
                {AREA_STORAGE_SPEAK (30,31,32,4,4,5) (35,35,35,32,33,34) 35}
                {OBJ_POTION_HOLY 30 35 object7_holywater1}
                {OBJ_POTION_HOLY 31 35 object7_holywater2}
                {OBJ_POTION_HOLY 32 35 object7_holywater3}
                {OBJ_POTION_HOLY 4 32 object7_holywater4}
                {OBJ_POTION_HOLY 4 33 object7_holywater5}
                {OBJ_POTION_HOLY 5 34 object7_holywater6}
                {DWARVEN_DOOR dungeon_door[3] 7 32 {COMMAND_DOOR_STORAGE2 dungeon_door[3] 6 32}}
                {DWARVEN_DOOR dungeon_door[4] 7 26 {COMMAND_DOOR dungeon_door[4] 7 25}}
                {DWARVEN_DOOR dungeon_door[5] 30 37 {COMMAND_DOOR_STORAGE1 dungeon_door[5] 31 37}}
                {DWARVEN_DOOR dungeon_door[6] 30 39 {COMMAND_DOOR dungeon_door[6] 31 40}}

                {VARIABLE cell_location[3] 4}
                {VARIABLE cell_location[4] 6}

                {PUT_PRISONER 0 3 0 (
                    [switch]
                        variable=captive[0]
                        [case]
                            value="0"
                            {PRISONER_KRASH 11 38 11 39 10 39 (4,5,7-8) (23-24,25,34)}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_KRASH 9 37 8 37 8 38 (4,5,7-8,9) (23-24,25,34,40)}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_KRASH 10 34 10 33 9 34 (4,5,7,9) (23-24,25,34,40)}
                        [/case]
                        [else]
                            {PRISONER_KRASH 7 25 7 24 6 24 (7-8,9) (34,40)}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 3 1 (
                    [switch]
                        variable=captive[1]
                        [case]
                            value="0"
                            {PRISONER_ELENIA 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_ELENIA 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_ELENIA 10 34 10 33}
                        [/case]
                        [case]
                            value="4"
                            {PRISONER_ELENIA 7 25 7 24}
                        [/case]
                        [else]
                            {PRISONER_ELENIA 31 40 32 39}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 2 2 (
                    [switch]
                        variable=captive[2]
                        [case]
                            value="0"
                            {PRISONER_THERA 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_THERA 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_THERA 10 34 10 33}
                        [/case]
                        [case]
                            value="4"
                            {PRISONER_THERA 7 25 7 24}
                        [/case]
                        [else]
                            {PRISONER_THERA 31 40 32 39}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 1 3 (
                    [switch]
                        variable=captive[3]
                        [case]
                            value="0"
                            {PRISONER_MORVIN 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_MORVIN 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_MORVIN 10 34 10 33}
                        [/case]
                        [case]
                            value="4"
                            {PRISONER_MORVIN 7 25 7 24}
                        [/case]
                        [else]
                            {PRISONER_MORVIN 31 40 32 39}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 0 4 (
                    [switch]
                        variable=captive[4]
                        [case]
                            value="0"
                            {PRISONER_DEAD 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_DEAD 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_DEAD 10 34 10 33}
                        [/case]
                        [case]
                            value="4"
                            {PRISONER_DEAD 7 25 7 24}
                        [/case]
                        [else]
                            {PRISONER_DEAD 31 40 32 39}
                        [/else]
                    [/switch]
                )}
            [/case]
            [case]
                value="4"
                [terrain]
                    x=4,5,30-32
                    y=32-33,34,35
                    terrain=Xu
                [/terrain]

                {AREA_STORAGE 7 24 ( _ "Ha ha, for skeletons anyway.")}
                {AREA_STORAGE 32 39 ( _ "(<i>Rolls eyes</i>) Oh, the hazardous life of a skeleton.")}
                {AREA_STORAGE_SPEAK (6,6,7,32,33,33) (23,24,23,40,39,40) 25}
                {OBJ_POTION_HOLY 6 23 object7_holywater1}
                {OBJ_POTION_HOLY 6 24 object7_holywater2}
                {OBJ_POTION_HOLY 7 23 object7_holywater3}
                {OBJ_POTION_HOLY 32 40 object7_holywater4}
                {OBJ_POTION_HOLY 33 39 object7_holywater5}
                {OBJ_POTION_HOLY 33 40 object7_holywater6}
                {DWARVEN_DOOR dungeon_door[3] 7 32 {COMMAND_DOOR dungeon_door[3] 6 32}}
                {DWARVEN_DOOR dungeon_door[4] 7 26 {COMMAND_DOOR_STORAGE1 dungeon_door[4] 7 25}}
                {DWARVEN_DOOR dungeon_door[5] 30 37 {COMMAND_DOOR dungeon_door[5] 31 37}}
                {DWARVEN_DOOR dungeon_door[6] 30 39 {COMMAND_DOOR_STORAGE2 dungeon_door[6] 31 40}}

                {VARIABLE cell_location[3] 3}
                {VARIABLE cell_location[4] 5}

                {PUT_PRISONER 0 3 0 (
                    [switch]
                        variable=captive[0]
                        [case]
                            value="0"
                            {PRISONER_KRASH 11 38 11 39 10 39 (4,5,7-8) (23-24,25,34)}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_KRASH 9 37 8 37 8 38 (4,5,7-8,9) (23-24,25,34,40)}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_KRASH 10 34 10 33 9 34 (4,5,7,9) (23-24,25,34,40)}
                        [/case]
                        [else]
                            {PRISONER_KRASH 6 32 5 33 6 33 (4,5,8,9) (23-24,25,34,40)}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 3 1 (
                    [switch]
                        variable=captive[1]
                        [case]
                            value="0"
                            {PRISONER_ELENIA 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_ELENIA 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_ELENIA 10 34 10 33}
                        [/case]
                        [case]
                            value="3"
                            {PRISONER_ELENIA 6 32 5 33}
                        [/case]
                        [else]
                            {PRISONER_ELENIA 31 37 31 36}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 2 2 (
                    [switch]
                        variable=captive[2]
                        [case]
                            value="0"
                            {PRISONER_THERA 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_THERA 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_THERA 10 34 10 33}
                        [/case]
                        [case]
                            value="3"
                            {PRISONER_THERA 6 32 5 33}
                        [/case]
                        [else]
                            {PRISONER_THERA 31 37 31 36}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 1 3 (
                    [switch]
                        variable=captive[3]
                        [case]
                            value="0"
                            {PRISONER_MORVIN 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_MORVIN 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_MORVIN 10 34 10 33}
                        [/case]
                        [case]
                            value="3"
                            {PRISONER_MORVIN 6 32 5 33}
                        [/case]
                        [else]
                            {PRISONER_MORVIN 31 37 31 36}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 0 4 (
                    [switch]
                        variable=captive[4]
                        [case]
                            value="0"
                            {PRISONER_DEAD 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_DEAD 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_DEAD 10 34 10 33}
                        [/case]
                        [case]
                            value="3"
                            {PRISONER_DEAD 6 32 5 33}
                        [/case]
                        [else]
                            {PRISONER_DEAD 31 37 31 36}
                        [/else]
                    [/switch]
                )}
            [/case]
            [case]
                value="5"
                [terrain]
                    x=4,5,33,32-33
                    y=32-33,34,39,40
                    terrain=Xu
                [/terrain]

                {AREA_STORAGE 7 24 ( _ "Ha ha, for skeletons anyway.")}
                {AREA_STORAGE 31 36 ( _ "(<i>Rolls eyes</i>) Oh, the hazardous life of a skeleton.")}
                {AREA_STORAGE_SPEAK (30,31,32,6,6,7) (35,35,35,23,24,23) 25}
                {OBJ_POTION_HOLY 30 35 object7_holywater1}
                {OBJ_POTION_HOLY 31 35 object7_holywater2}
                {OBJ_POTION_HOLY 32 35 object7_holywater3}
                {OBJ_POTION_HOLY 6 23 object7_holywater4}
                {OBJ_POTION_HOLY 6 24 object7_holywater5}
                {OBJ_POTION_HOLY 7 23 object7_holywater6}
                {DWARVEN_DOOR dungeon_door[3] 7 32 {COMMAND_DOOR dungeon_door[3] 6 32}}
                {DWARVEN_DOOR dungeon_door[4] 7 26 {COMMAND_DOOR_STORAGE1 dungeon_door[4] 7 25}}
                {DWARVEN_DOOR dungeon_door[5] 30 37 {COMMAND_DOOR_STORAGE2 dungeon_door[5] 31 37}}
                {DWARVEN_DOOR dungeon_door[6] 30 39 {COMMAND_DOOR dungeon_door[6] 31 40}}

                {VARIABLE cell_location[3] 3}
                {VARIABLE cell_location[4] 6}

                {PUT_PRISONER 0 3 0 (
                    [switch]
                        variable=captive[0]
                        [case]
                            value="0"
                            {PRISONER_KRASH 11 38 11 39 10 39 (4,5,7-8) (23-24,25,34)}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_KRASH 9 37 8 37 8 38 (4,5,7-8,9) (23-24,25,34,40)}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_KRASH 10 34 10 33 9 34 (4,5,7,9) (23-24,25,34,40)}
                        [/case]
                        [else]
                            {PRISONER_KRASH 6 32 5 33 6 33 (4,5,8,9) (23-24,25,34,40)}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 3 1 (
                    [switch]
                        variable=captive[1]
                        [case]
                            value="0"
                            {PRISONER_ELENIA 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_ELENIA 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_ELENIA 10 34 10 33}
                        [/case]
                        [case]
                            value="3"
                            {PRISONER_ELENIA 6 32 5 33}
                        [/case]
                        [else]
                            {PRISONER_ELENIA 31 40 32 39}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 2 2 (
                    [switch]
                        variable=captive[2]
                        [case]
                            value="0"
                            {PRISONER_THERA 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_THERA 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_THERA 10 34 10 33}
                        [/case]
                        [case]
                            value="3"
                            {PRISONER_THERA 6 32 5 33}
                        [/case]
                        [else]
                            {PRISONER_THERA 31 40 32 39}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 1 3 (
                    [switch]
                        variable=captive[3]
                        [case]
                            value="0"
                            {PRISONER_MORVIN 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_MORVIN 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_MORVIN 10 34 10 33}
                        [/case]
                        [case]
                            value="3"
                            {PRISONER_MORVIN 6 32 5 33}
                        [/case]
                        [else]
                            {PRISONER_MORVIN 31 40 32 39}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 0 4 (
                    [switch]
                        variable=captive[4]
                        [case]
                            value="0"
                            {PRISONER_DEAD 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_DEAD 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_DEAD 10 34 10 33}
                        [/case]
                        [case]
                            value="3"
                            {PRISONER_DEAD 6 32 5 33}
                        [/case]
                        [else]
                            {PRISONER_DEAD 31 40 32 39}
                        [/else]
                    [/switch]
                )}
            [/case]
            [else]
                [terrain]
                    x=33,32-33,30-32
                    y=39,40,35
                    terrain=Xu
                [/terrain]

                {AREA_STORAGE 7 24 ( _ "Ha ha, for skeletons anyway.")}
                {AREA_STORAGE 5 33 ( _ "(<i>Rolls eyes</i>) Oh, the hazardous life of a skeleton.")}
                {AREA_STORAGE_SPEAK (4,4,5,6,6,7) (32,33,34,23,24,23) 25}
                {OBJ_POTION_HOLY 4 32 object7_holywater1}
                {OBJ_POTION_HOLY 4 33 object7_holywater2}
                {OBJ_POTION_HOLY 5 34 object7_holywater3}
                {OBJ_POTION_HOLY 6 23 object7_holywater4}
                {OBJ_POTION_HOLY 6 24 object7_holywater5}
                {OBJ_POTION_HOLY 7 23 object7_holywater6}
                {DWARVEN_DOOR dungeon_door[3] 7 32 {COMMAND_DOOR_STORAGE1 dungeon_door[3] 6 32}}
                {DWARVEN_DOOR dungeon_door[4] 7 26 {COMMAND_DOOR_STORAGE2 dungeon_door[4] 7 25}}
                {DWARVEN_DOOR dungeon_door[5] 30 37 {COMMAND_DOOR dungeon_door[5] 31 37}}
                {DWARVEN_DOOR dungeon_door[6] 30 39 {COMMAND_DOOR dungeon_door[6] 31 40}}

                {VARIABLE cell_location[3] 5}
                {VARIABLE cell_location[4] 6}

                {PUT_PRISONER 0 2 0 (
                    [switch]
                        variable=captive[0]
                        [case]
                            value="0"
                            {PRISONER_KRASH 11 38 11 39 10 39 (4,5,7-8) (23-24,25,34)}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_KRASH 9 37 8 37 8 38 (4,5,7-8,9) (23-24,25,34,40)}
                        [/case]
                        [else]
                            {PRISONER_KRASH 10 34 10 33 9 34 (4,5,7,9) (23-24,25,34,40)}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 3 1 (
                    [switch]
                        variable=captive[1]
                        [case]
                            value="0"
                            {PRISONER_ELENIA 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_ELENIA 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_ELENIA 10 34 10 33}
                        [/case]
                        [case]
                            value="5"
                            {PRISONER_ELENIA 31 37 31 36}
                        [/case]
                        [else]
                            {PRISONER_ELENIA 31 40 32 39}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 2 2 (
                    [switch]
                        variable=captive[2]
                        [case]
                            value="0"
                            {PRISONER_THERA 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_THERA 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_THERA 10 34 10 33}
                        [/case]
                        [case]
                            value="5"
                            {PRISONER_THERA 31 37 31 36}
                        [/case]
                        [else]
                            {PRISONER_THERA 31 40 32 39}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 1 3 (
                    [switch]
                        variable=captive[3]
                        [case]
                            value="0"
                            {PRISONER_MORVIN 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_MORVIN 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_MORVIN 10 34 10 33}
                        [/case]
                        [case]
                            value="5"
                            {PRISONER_MORVIN 31 37 31 36}
                        [/case]
                        [else]
                            {PRISONER_MORVIN 31 40 32 39}
                        [/else]
                    [/switch]
                )}
                {PUT_PRISONER 0 0 4 (
                    [switch]
                        variable=captive[4]
                        [case]
                            value="0"
                            {PRISONER_DEAD 11 38 11 39}
                        [/case]
                        [case]
                            value="1"
                            {PRISONER_DEAD 9 37 8 37}
                        [/case]
                        [case]
                            value="2"
                            {PRISONER_DEAD 10 34 10 33}
                        [/case]
                        [case]
                            value="5"
                            {PRISONER_DEAD 31 37 31 36}
                        [/case]
                        [else]
                            {PRISONER_DEAD 31 40 32 39}
                        [/else]
                    [/switch]
                )}
            [/else]
        [/switch]

        {PUT_TREASURE 0 2 0 (
            [switch]
                variable=pile[0]
                [case]
                    value="0"
                    {TREASURE_ARTIFACT 2 3 (1,2,2,3) (3-4,2,4,3-4)}
                [/case]
                [case]
                    value="1"
                    {TREASURE_ARTIFACT 2 9 (1,2,2,3) (9-10,8,10,9-10)}
                [/case]
                [else]
                    {TREASURE_ARTIFACT 20 2 (19,20,20,21) (2-3,1,3,2)}
                [/else]
            [/switch]
        )}
        {PUT_TREASURE 0 2 1 (
            [switch]
                variable=pile[1]
                [case]
                    value="0"
                    {TREASURE_BONES 2 3 (1,2,2,3) (3-4,2,4,3-4) 0}
                [/case]
                [case]
                    value="1"
                    {TREASURE_BONES 2 9 (1,2,2,3) (9-10,8,10,9-10) 0}
                [/case]
                [case]
                    value="2"
                    {TREASURE_BONES 20 2 (19,20,20,21) (2-3,1,3,2) 0}
                [/case]
                [else]
                    {TREASURE_BONES $prisoner_dead[2] $prisoner_dead[3] $prisoner_dead[0] $prisoner_dead[1] 1}
                [/else]
            [/switch]
        )}
        {PUT_TREASURE 0 1 2 (
            [switch]
                variable=pile[2]
                [case]
                    value="0"
                    {TREASURE_GOLD 2 3 (1,2,2,3) (3-4,2,4,3-4)}
                [/case]
                [case]
                    value="1"
                    {TREASURE_GOLD 2 9 (1,2,2,3) (9-10,8,10,9-10)}
                [/case]
                [case]
                    value="2"
                    {TREASURE_GOLD 20 2 (19,20,20,21) (2-3,1,3,2)}
                [/case]
                [else]
                    {TREASURE_GOLD $prisoner_dead[2] $prisoner_dead[3] $prisoner_dead[0] $prisoner_dead[1]}
                [/else]
            [/switch]
        )}
        {PUT_TREASURE 0 0 3 (
            [switch]
                variable=pile[3]
                [case]
                    value="0"
                    {TREASURE_DUST 2 3 (1,2,2,3) (3-4,2,4,3-4)}
                [/case]
                [case]
                    value="1"
                    {TREASURE_DUST 2 9 (1,2,2,3) (9-10,8,10,9-10)}
                [/case]
                [case]
                    value="2"
                    {TREASURE_DUST 20 2 (19,20,20,21) (2-3,1,3,2)}
                [/case]
                [else]
                    {TREASURE_DUST $prisoner_dead[2] $prisoner_dead[3] $prisoner_dead[0] $prisoner_dead[1]}
                [/else]
            [/switch]
        )}

        {RANDOM 0..2}

        [switch]
            variable=random
            [case]
                value="0"
                {HAUNTED_TUNNEL (37,39) (37,40) 29 26 29 25}
            [/case]
            [case]
                value="1"
                {HAUNTED_TUNNEL (29,39) (26,40) 37 37 36 37}
            [/case]
            [else]
                {HAUNTED_TUNNEL (37,29) (37,26) 39 40 40 39}                
            [/else]
        [/switch]

        {RANDOM 0..1}

        [switch]
            variable=random
            [case]
                value="0"
                {CORPSE 39 18 ( _ "Here’s another body.")}
            [/case]
            [else]
                {CORPSE 36 16 ( _ "Here’s another body.")}
            [/else]
        [/switch]

        {RANDOM 0..1}

        [switch]
            variable=random
            [case]
                value="0"
                {BLIND_END 39 16}
            [/case]
            [else]
                [terrain]
                    x=40
                    y=14-15
                    terrain=Ww
                [/terrain]
                [terrain]
                    x=36
                    y=14
                    terrain=Xu
                [/terrain]
                {BLIND_END 37 15}
            [/else]
        [/switch]

        {RANDOM 0..1}

        [switch]
            variable=random
            [case]
                value="0"
                [terrain]
                    x=31
                    y=9
                    terrain=Ww
                [/terrain]
                {NAGA_ENCOUNTER (29-30,30,31-34) (8,7,9-12)}
            [/case]
            [else]
                [terrain]
                    x=32
                    y=8
                    terrain=Ww
                [/terrain]
                {NAGA_ENCOUNTER (32,33,31-34) (6-8,7,9-12)}
            [/else]
        [/switch]

        {RANDOM 0..1}

        [if]
            [variable]
                name=random
                numerical_equals=0
            [/variable]
        [then]
            [terrain]
                x=27
                y=7
                terrain=Ww
            [/terrain]
            [terrain]
                x=28
                y=5
                terrain=Xu
            [/terrain]
        [/then]
        [/if]

        {RANDOM 0..1}

        # Set up some variables that need an initial value
        {VARIABLE mage_death_pursuit 1}

        [if]
            [variable]
                name=random
                numerical_equals=0
            [/variable]
        [then]
            {VARIABLE malifor_spawn_x[0] 20}
            {VARIABLE malifor_spawn_y[0] 15}
            {VARIABLE malifor_spawn_x[1] 34}
            {VARIABLE malifor_spawn_y[1] 10}
        [/then]
        [else]
            {VARIABLE malifor_spawn_x[0] 34}
            {VARIABLE malifor_spawn_y[0] 10}
            {VARIABLE malifor_spawn_x[1] 20}
            {VARIABLE malifor_spawn_y[1] 15}
        [/else]
        [/if]

        {VARIABLE malifor_spawn_x[2] 16}
        {VARIABLE malifor_spawn_y[2] 9}
        {VARIABLE malifor_spawn_x[3] 24}
        {VARIABLE malifor_spawn_y[3] 9}

        {UNDEAD_TROOPS_LIGHT 5}
        {UNDEAD_TROOPS_LIGHT 6}
    [/event]

    [event]
        name=start

        [capture_village]
            side=5
            x=29,29
            y=37,40
        [/capture_village]
        [capture_village]
            side=6
            x=5,5
            y=27,29
        [/capture_village]

        # Malifor escapes into shroud
        [hide_unit]
            x=20
            y=39
        [/hide_unit]

        {UNIT 3 Draug 10 20 (
            id=Treasury Chieftain
            role=Treasury Guard
            {UNIT_AI_GUARD 10 20}
        )}
        {UNIT 3 Draug 25 22 (
            role=Study Guard
            {UNIT_AI_GUARD 25 22}
        )}
        {PUT_MALIFOR_GUARD Draug 25 27}
        {PUT_MALIFOR_GUARD Draug 27 28}
        {PUT_MALIFOR_GUARD Draug 27 23}
        {PUT_MALIFOR_GUARD Draug 27 20}
        {PUT_MALIFOR_GUARD Draug 29 21}
        {PUT_MALIFOR_GUARD Draug 31 21}
        {PUT_MALIFOR_GUARD Draug 33 20}
        # And larger army of Revenants
        {UNIT 3 Revenant 16 34 (
            role=Dungeon Guard
            [modifications]
                [object]
                    silent=yes
                    # Do not ever use replace if you want to have easy way to get back original state
                    [effect]
                        apply_to=movement_costs 
                        replace=false
                        [movement_costs]
                            flat=30
                        [/movement_costs]
                    [/effect]
                [/object]
            [/modifications]
        )}
        {UNIT 3 Revenant 11 35 (
            role=Dungeon Guard
            {UNIT_AI_GUARD 11 35}
        )}
        {UNIT 3 Revenant 12 20 (
            role=Treasury Guard
            {UNIT_AI_GUARD 12 20}
        )}
        {PUT_MALIFOR_GUARD Revenant 14 25}
        {PUT_MALIFOR_GUARD Revenant 16 26}
        {PUT_MALIFOR_GUARD Revenant 19 35}
        {PUT_MALIFOR_GUARD Revenant 19 27}
        {PUT_MALIFOR_GUARD Revenant 19 24}
        {PUT_MALIFOR_GUARD Revenant 19 21}
        {PUT_MALIFOR_GUARD Revenant 21 35}
        {PUT_MALIFOR_GUARD Revenant 21 27}
        {PUT_MALIFOR_GUARD Revenant 21 24}
        {PUT_MALIFOR_GUARD Revenant 21 21}
        {PUT_MALIFOR_GUARD Revenant 10 37}
        {PUT_MALIFOR_GUARD Revenant 13 32}
        {PUT_MALIFOR_GUARD Revenant 8 30}
        {PUT_MALIFOR_GUARD Revenant 8 28}
        {PUT_MALIFOR_GUARD Revenant 12 18}
        {PUT_MALIFOR_GUARD Revenant 6 19}
        {PUT_MALIFOR_GUARD Revenant 8 19}
        {PUT_MALIFOR_GUARD Revenant 8 17}
        {PUT_MALIFOR_GUARD Revenant 10 16}
        {PUT_MALIFOR_GUARD Revenant 9 15}
        {PUT_MALIFOR_GUARD Revenant 26 33}
        {PUT_MALIFOR_GUARD Revenant 27 32}
        {PUT_MALIFOR_GUARD Revenant 27 37}
        {PUT_MALIFOR_GUARD Revenant 27 38}
        {PUT_MALIFOR_GUARD Revenant 30 38}
        {PUT_MALIFOR_GUARD Revenant 24 37}
        {PUT_MALIFOR_GUARD Revenant 25 38}

        # I need to check that player has dwarven support or not to make the message have any sense...
        [if]
            [variable]
                name=dwarven_support
                numerical_equals=1
            [/variable]
        [then]
            [message]
                speaker=narrator
                message= _ "Leaving most of the dwarves behind, Tallin and the rest of his party set off to pursue the Sorcerer."
                image=wesnoth-icon.png
            [/message]
        [/then]
        [else]
             [message]
                speaker=narrator
                message= _ "Leaving the dwarves behind, Tallin and the rest of his party set off to pursue the Sorcerer."
                image=wesnoth-icon.png
            [/message]
        [/else]
        [/if]

        [move_unit_fake]
            type=Ancient Lich
            side=4
            x=20,20,20,20,20,20,20
            y=39,38,37,36,35,34,33
        [/move_unit_fake]
        [unhide_unit]
        [/unhide_unit]
        # Recall some units
        {RECALL_SUPPORTER}

        [if]
            [variable]
                name=dwarven_support
                numerical_equals=1
            [/variable]
        [then]
            # I will try to get most effective unit against undead from player recall list
            {RECALL_DWARVEN_MAULER follower}
        [/then]
        [else]
            # Since I have no idea what unit player have I will fix situation simply by trying to give him unit that is effective against skeletons
            # In worst case it will give him another unit to sacrifice...
            {RECALL_MAULER Mauler}
        [/else]
        [/if]

        # Not needed so cleared
        {CLEAR_VARIABLE dwarven_support}

        [recall]
            id=Camerin
        [/recall]

        [if]
            [not]
                [have_unit]
                    id=Camerin
                [/have_unit]
            [/not]
        [then]
            {RECALL_MAULER "Mauler 2"}
        [/then]
        [/if]

        # Initial dialogue and objectives
        {SPEAKER_GENERIC (speaker=Tallin) ( _ "There he goes! Quick, get him!")}
        {SPEAKER_GENERIC (type=Revenant) ( _ "I don’t think so, you living vermin.")}
        {SPEAKER_GENERIC (speaker=Tallin) ( _ "We’ll have to kill these revenants to get after him. There are only two of them, so they shouldn’t last long.")}
        {OBJECTIVES_PURSUIT ( _ "Get past the Revenants.") ()}
    [/event]

    [event]
        name=turn 2

        [sound]
             name=melee-fire.ogg
             repeat=1
        [/sound]
        {OPEN_DWARVEN_DOOR (9,25,26) (29-30,37,36)}
        [redraw]
            side=1
        [/redraw]

        [if]
            [have_unit]
                side=1
                role=Supporter
            [/have_unit]
        [then]
            {SPEAKER_GENERIC (role=Supporter) ( _ "You heard that? I don't like this sound. Hurry!")}
        [/then]
        [else]
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "You heard that? I don't like this sound. Hurry!")}
        [/else]
        [/if]
    [/event]

    [event]
        name=turn 30

        #ifndef EASY
            [event]
                name=side 3 turn
                first_time_only=no

                {BEHOLDER_GATE 5 fighters1 0 (25,26) (37,36) (25,26) (33-36,33-35) (24,25,26,27,28,29,30,30,31,31,32,32-33) (37-38,37-40,36-40,37-40,36-40,37-40,35,37-39,35-37,39,35,39-40) (28) (36)}
                {BEHOLDER_GATE 6 fighters2 1 (9) (29-30) (10,11-12,13,14) (29-30,30-31,31-32,31) (4,5,5,6,6,7,8,9) (32-33,27-31,33-34,23-24,26-32,23-32,28-30,29-30) (7) (26)}
            [/event]
        #endif
    [/event]

    [event]
        name=new turn
        first_time_only=no

        [if]
            [variable]
                name=confronted_malifor
                numerical_equals=1
            [/variable]
            [and]
                [have_unit]
                    side=1
                    id=Father Morvin
                [/have_unit]
                [or]
                    [have_unit]
                        side=1
                        id=Sister Thera
                    [/have_unit]
                [/or]
            [/and]
        [then]
            {MALIFOR_MAGE_SPEAK}
            {CONFRONTATION_PURSUIT}
        [/then]
        [/if]
    [/event]

    [event]
        name=side 2 turn
        first_time_only=no

        [if]
            [variable]
                name=great_chamber
                less_than=1
            [/variable]
        [then]
            [store_unit]
                [filter]
                    side=1
                    x=20,18-22,16-24,18-22
                    y=11,12,13-17,18
                [/filter]
                kill=no
                variable=assaulters
            [/store_unit]

            [if]
                [variable]
                    name=assaulters[0].x
                    greater_than=0
                [/variable]
            [then]
                {REVEAL_SIDE 2 reveal_monsters}
                {SPEAKER_GENERIC (id=$assaulters[0].id) ( _ "So this is the Great Chamber eh? Doesn’t look like there is much to see here.")}
                # This macro should shake the screen
                {QUAKE "rumble.ogg"}
                {SPEAKER_GENERIC (id=$assaulters[0].id) ( _ "Perhaps I spoke too soon...")}
                [sound]
                    name=thunderstick.ogg
                [/sound]
                # Cutting off the exit
                [terrain]
                    x=20
                    y=20
                    terrain=Xu
                [/terrain]
                [redraw]
                    side=1
                [/redraw]
                [kill]
                    x=20
                    y=20
                    animate=yes
                [/kill]
                {SPEAKER_GENERIC (id=$assaulters[0].id) ( _ "What was that? Oh, woe — we are trapped!")}

                # Spawning spiders 10,14,18 or 22 depending on difficulty levels split in half on both sides of the chamber
                {NOTRAIT_UNIT 2 "Giant Spider" 22 8}
                {NOTRAIT_UNIT 2 "Giant Spider" 23 9}
                {NOTRAIT_UNIT 2 "Giant Spider" 24 9}
                {NOTRAIT_UNIT 2 "Giant Spider" 24 10}
                {NOTRAIT_UNIT 2 "Giant Spider" 24 11}
                {NOTRAIT_UNIT 2 "Giant Spider" 18 8}
                {NOTRAIT_UNIT 2 "Giant Spider" 17 9}
                {NOTRAIT_UNIT 2 "Giant Spider" 16 9}
                {NOTRAIT_UNIT 2 "Giant Spider" 16 10}
                {NOTRAIT_UNIT 2 "Giant Spider" 16 11}
                #ifndef EASY
                    {NOTRAIT_UNIT 2 "Giant Spider" 25 9}
                    {NOTRAIT_UNIT 2 "Giant Spider" 25 10}
                    {NOTRAIT_UNIT 2 "Giant Spider" 16 8}
                    {NOTRAIT_UNIT 2 "Giant Spider" 15 9}
                #ifndef NORMAL
                    {NOTRAIT_UNIT 2 "Giant Spider" 23 10}
                    {NOTRAIT_UNIT 2 "Giant Spider" 23 11}
                    {NOTRAIT_UNIT 2 "Giant Spider" 17 10}
                    {NOTRAIT_UNIT 2 "Giant Spider" 17 11}
                #ifndef HARD
                    {NOTRAIT_UNIT 2 "Giant Spider" 22 9}
                    {NOTRAIT_UNIT 2 "Giant Spider" 22 10}
                    {NOTRAIT_UNIT 2 "Giant Spider" 18 9}
                    {NOTRAIT_UNIT 2 "Giant Spider" 18 10}
                #endif
                #endif
                #endif

                [sound]
                    name=melee-fire.ogg
                    repeat=1
                [/sound]
                {OPEN_DWARVEN_DOOR (17,18,22,23) (12,11,11,12)}
                [redraw]
                    side=1
                [/redraw]
                [sound]
                    name=hiss-big.wav
                [/sound]
                # wmllint: no spellcheck
                {SPEAKER_GENERIC (type=Giant Spider) ( _ "Hsssss")}

                [if]
                    [variable]
                        name=assaulters[0].role
                        not_equals=Supporter
                    [/variable]
                [then]
                    {SPEAKER_GENERIC (id=$assaulters[0].id) ( _ "This doesn’t look good.")}
                [/then]
                [/if]

                {SPEAKER_GENERIC (role=Supporter) ( _ "‘Great Chamber’, my foot! This is a death chamber!")}
                {VARIABLE great_chamber 1}
            [/then]
            [/if]

            {CLEAR_VARIABLE assaulters}
        [/then]
        [/if]

        [if]
            [variable]
                name=dungeon_door[$captive[4]]
                greater_than=0
            [/variable]
            [and]
                [variable]
                    name=cell_bones
                    greater_than=0
                [/variable]
            [/and]
        [then]
            {BONES_ENCOUNTER $prisoner_dead[2] $prisoner_dead[3]}
        [/then]
        [/if]
    [/event]

    {FORCES_UNDEAD 5 0}
    {FORCES_UNDEAD 6 1}
    {FORCES_UNDEAD 7 2}
    {FORCES_UNDEAD 8 3}
    {FORCES_UNDEAD 9 4}

    # Player start this scenario with limited number of units so he can lose them all if they are low leveled ones or just he is unlucky.
    # The side effect of this situation is that there will be no supporter so we have to fix this
    [event]
        name=recruit

        [filter]
            side=1
        [/filter]

        [if]
            [not]
                [have_unit]
                    role=Supporter
                [/have_unit]
            [/not]
        [then]
            [role]
                side=1
                [not]
                    id=Tallin
                [/not]
                [not]
                    id=Camerin
                [/not]
                role=Supporter
            [/role]
        [/then]
        [/if]

        [if]
            [variable]
                name=pursuit_squad_destroyed
                numerical_equals=1
            [/variable]
        [then]
            {BEGIN_PURSUIT}
            {CLEAR_VARIABLE pursuit_squad_destroyed}
        [/then]
        [/if]
    [/event]

    [event]
        name=recall

        [filter]
            side=1
        [/filter]

        [if]
            [not]
                [have_unit]
                    side=1
                    role=Supporter
                [/have_unit]
            [/not]
        [then]
            [role]
                side=1
                [not]
                    id=Tallin
                [/not]
                [not]
                    id=Camerin
                [/not]
                role=Supporter
            [/role]    
        [/then]
        [/if]

        [if]
            [variable]
                name=pursuit_squad_destroyed
                numerical_equals=1
            [/variable]
        [then]
            {BEGIN_PURSUIT}
            {CLEAR_VARIABLE pursuit_squad_destroyed}
        [/then]
        [/if]
    [/event]

    # Doors
    {DWARVEN_DOOR dungeon_door[0] 11 37 {COMMAND_DOOR dungeon_door[0] 11 38}}
    {DWARVEN_DOOR dungeon_door[1] 10 36 {COMMAND_DOOR dungeon_door[1] 9 37}}
    {DWARVEN_DOOR dungeon_door[2] 10 35 {COMMAND_DOOR dungeon_door[2] 10 34}}

    # Player enters the first chamber - some more initial dialogues and objectives
    # Note: This conversation is pointless if player lost all his units
    [event]
        name=moveto
        [filter]
            side=1
            x=19-21
            y=30-32
        [/filter]

        [if]
            [have_unit]
                side=1
                [not]
                    id=Tallin
                [/not]
            [/have_unit]
        [then]
            {SPEAKER_GENERIC (speaker=unit) ( _ "Uh... Which way?")}
            {BEGIN_PURSUIT}
        [/then]
        [else]
            {VARIABLE pursuit_squad_destroyed 1}
        [/else]
        [/if]
    [/event]

    # From this point on we can go in seven directions, one of these leads to enemy castle and has no events involved, another one
    # leads only to holy water storage and as such is merged into study module. Out of the remaining, going clockwise, we have:

    # Prison
    {AREA_DESCRIPTION 16 31 ( _ "The Dungeon") "scenery/monolith2.png" (
        [if]
            [variable]
                name=unit.id
                not_equals=Tallin
            [/variable]
        [then]
           {SPEAKER_GENERIC (speaker=unit) ( _ "Those poor wretches!")}
        [/then]
        [else]
           {SPEAKER_GENERIC (role=Supporter) ( _ "Those poor wretches!")}
        [/else]
        [/if]

        {SPEAKER_GENERIC (speaker=Tallin) ( _ "We won’t leave them in Malifor's chains!")}
    )}

    [event]
        name=moveto

        [filter]
            side=1
            x=1-5,1-2
            y=22-25,26-27
        [/filter]

        [if]
            [variable]
                name=underground_lake
                greater_than=0
            [/variable]
        [then]
            {SPEAKER_GENERIC (speaker=unit) ( _ "(<i>Sigh</i>) Great. More water. And there doesn’t seem to be anything down this tunnel, either friend or foe.")}
        [/then]
        [else]
            {SPEAKER_GENERIC (speaker=unit) ( _ "(<i>Sigh</i>) Water. Great. And there doesn’t seem to be anything down this tunnel, either friend or foe.")}
        [/else]
        [/if]
    [/event]

    # Player meets three dwarves that escaped from the dungeon some time ago, they join the army and show a back entrance to the treasury
    [event]
        name=moveto

        [filter]
            side=1
            x=6-11
            y=9-13
        [/filter]

        # Remove some shroud and place the units
        [remove_shroud]
            side=1
            x=6-11
            y=9-13
        [/remove_shroud]
        {UNIT 1 "Dwarvish Steelclad" 11 10 (
            id=Dulcatas
            name= _ "Dulcatas"
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_HEALTHY}
            [/modifications]
            {IS_LOYAL}
        )}
        {UNIT 1 "Dwarvish Thunderguard" 9 10 (
            id=Antolos
            name= _ "Antolos"
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
            [/modifications]
            {IS_LOYAL}
        )}
        {UNIT 1 "Dwarvish Fighter" 9 12 (
            id=Varem
            name= _ "Varem"
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
            {IS_LOYAL}
        )}
        {SPEAKER_GENERIC (speaker=Dulcatas) ( _ "Halt! Who goes there? Friend or foe?")}
        {SPEAKER_GENERIC (speaker=unit) ( _ "Depends. Are you loyal to Malifor?")}
        {SPEAKER_GENERIC (speaker=Dulcatas) ( _ "Never! If you ha’ been sent by Malifor, then know that we will never yield! Come and meet your death!")}
        {SPEAKER_GENERIC (speaker=unit) ( _ "Hold! We aren’t friends of Malifor in the least. Rather, we have come to destroy him.")}
        {SPEAKER_GENERIC (speaker=Dulcatas) ( _ "Finally! You don’t know how long we have been waiting for this day.")}
        {SPEAKER_GENERIC (speaker=unit) ( _ "How did you get here and how long have you been here?")}
        {SPEAKER_GENERIC (speaker=Dulcatas) ( _ "We were originally prisoners of Malifor, but we tunneled out and escaped. Since then, we have eked out a precarious survival on what we have been able to steal or raid from Malifor.")}
        {SPEAKER_GENERIC (speaker=unit) ( _ "By now you have tunnels all through this place.")}
        {SPEAKER_GENERIC (speaker=Dulcatas) ( _ "Aye. That seemingly blank wall to the south there is actually a hidden entrance to the treasury.")}
        {SPEAKER_GENERIC (speaker=unit) ( _ "Awesome, let’s go!")}
        # Since the player doesn't know about the entrance until shown it this event can be set up only after meeting the dwarfs
        [event]
            name=moveto
            [filter]
                side=1
                x=8
                y=13
            [/filter]

            # Open the back entrance
            {SPEAKER_GENERIC (speaker=unit) ( _ "Here we go.")}
            {OPEN_DWARVEN_DOOR 8 14}
            [redraw]
                side=1
            [/redraw]
            # If the treasury alarm wasn't raised yet do it now and set the flag
            {MOBILIZE_TREASURY (speaker=unit)}
        [/event]
    [/event]

    # Treasury
    # 2 - Treasury - Signpost
    {AREA_DESCRIPTION 17 30 ( _ "The Treasury") "scenery/monolith2.png" (
        {SPEAKER_GENERIC (speaker=unit) ( _ "The Treasury! Cool, let’s go loot some booty!")}
    )}

    # 2a - Alarm
    # The Great Chamber
    # 3 - The Great Chamber - signpost
    {AREA_DESCRIPTION 20 29 ( _ "The Great Chamber") "scenery/monolith2.png" (
        {SPEAKER_GENERIC (speaker=unit) ( _ "‘The Great Chamber’? Hmmm, wonder what that could be.")}
    )}

    # 3b - Rod of Justice
    # At the end of the left side corridor. Uberpowerfull artifact that can be picked up by any unit with exception of Abhai.
    # 4 - Signpost
    {AREA_DESCRIPTION 23 30 ( _ "Malifor the Great’s Study") "scenery/monolith2.png" (
        {SPEAKER_GENERIC (speaker=unit) ( _ "There we go! This way, guys!")}
    )}

    # The flooded path
    # In the beginning, there was a signpost...
    # 5 - The flooded path - Signpost
    {AREA_DESCRIPTION 24 31 ( _ "Caution! Tunnel flooded and infested with aquatic monsters. Enter at the risk of your life.") "scenery/monolith2.png" (
        {SPEAKER_GENERIC (speaker=unit) ( _ "Interesting. It seems like someone really doesn’t want us going down this tunnel.")}
    )}

    # Which pointed towards the lake with a creepy tentacled monster...
    # 5a - Monster of the lake
    [event]
        name=moveto

        [filter]
            side=1
            x=32,34,31-36,30-36,38-39,30-37,32-36,35-37
            y=27,27,28,29-30,30,31,32,33
        [/filter]

        {REVEAL_SIDE 2 reveal_monsters}
        {VARIABLE underground_lake 1}
        {SPEAKER_GENERIC (speaker=unit) ( _ "Hey, an underground lake.")}
        # We don't have tentacled monsters as such but we do have a single tentacle unit
        [sound]
            name=water-blast.wav
        [/sound]
        {NOTRAIT_UNIT 2 "Tentacle of the Deep" 32 28}
        {NOTRAIT_UNIT 2 "Tentacle of the Deep" 34 29}
        {NOTRAIT_UNIT 2 "Tentacle of the Deep" 36 30}
        {NOTRAIT_UNIT 2 "Tentacle of the Deep" 36 32}
        #ifndef EASY
            {NOTRAIT_UNIT 2 "Tentacle of the Deep" 33 29}
            {NOTRAIT_UNIT 2 "Tentacle of the Deep" 35 30}
        #ifndef NORMAL
            {NOTRAIT_UNIT 2 "Tentacle of the Deep" 33 28}
            {NOTRAIT_UNIT 2 "Tentacle of the Deep" 36 33}
        #ifndef HARD
            {NOTRAIT_UNIT 2 "Tentacle of the Deep" 34 28}
            {NOTRAIT_UNIT 2 "Tentacle of the Deep" 35 29}
        #endif
        #endif
        #endif

        [if]
            [variable]
                name=unit.id
                not_equals=Camerin
            [/variable]
        [then]
            {SPEAKER_GENERIC (speaker=unit) ( _ "Ack! What are those things!")}
        [/then]
        [else]
            {SPEAKER_GENERIC (role=Supporter) ( _ "Ack! What are those things!")}
        [/else]
        [/if]

        [if]
            [have_unit]
                id=Camerin
            [/have_unit]
        [then]
            {SPEAKER_GENERIC (speaker=Camerin) ( _ "Oh yeah, those things. Watch out, they are the arms of some sort of underwater creature. They’ll try to pummel you to death, then drag you under for dinner.")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "Then how do we get past? I can see that the passage continues to both the north and south and we haven’t found Malifor yet...")}
            {SPEAKER_GENERIC (speaker=Camerin) ( _ "Creatures of that type regenerate over time; it’s doubtful we can destroy it completely. But if we destroy its arms we’ll be relatively safe until they regenerate.")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "Let’s get to it, then.")}
        [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x=35-37
            y=4-6
        [/filter]

        # wmllint: local spelling Ssssh
        {SPEAKER_GENERIC (speaker=unit) ( _ "Ssssh! I hear something.")}

        [if]
            [variable]
                name=unit.x
                numerical_equals=35
            [/variable]
            [and]
                [variable]
                    name=unit.y
                    numerical_equals=6
                [/variable]
            [/and]
        [then]
            {NOTRAIT_UNIT 2 "Cave Serpent" 35 5}
        [/then]
        [else]
            {NOTRAIT_UNIT 2 "Cave Serpent" 35 6}
        [/else]
        [/if]

        # wmllint: no spellcheck
        {SPEAKER_GENERIC (type=Cave Serpent) ( _ "ROOOAAARRR!")}
        {SPEAKER_GENERIC (speaker=unit) ( _ "Ahhh!")}
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x=20,18-22,16-24,18-22,19-21,20,19-21,19,21
            y=11,12,13-17,18,19,20,21,22,22
        [/filter]

        [if]
            [variable]
                name=unit.id
                equals=Tallin
            [/variable]
        [then]
            {SPEAKER_GENERIC (role=Supporter) ( _ "Look at these massive gates. If they would be locked we wouldn't have a chance to open it...")}
        [/then]
        [else]
            {SPEAKER_GENERIC (speaker=unit) ( _ "Look at these massive gates. If they would be locked we wouldn't have a chance to open it...")}
        [/else]
        [/if]

        {HIGHLIGHT_IMAGE 20 20 scenery/dwarven-doors-closed.png ()}
        {SPEAKER_GENERIC (speaker=Tallin) ( _ "So, lets make sure to stand on the right side of them then.")}
        [allow_undo][/allow_undo]
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1
            x=27
            y=12
        [/filter]

        [if]
            # If we’re at spider door and they're still closed...
            [variable]
                name=dungeon_door[7]
                less_than=1
            [/variable]
        # Give the player option to open them
        [then]
            {SPEAKER_GENERIC (speaker=unit) ( _ "Hmmm, another door. Boy, is this one sure locked up.")}
            [if]
                [variable]
                    name=unit.id
                    not_equals=Tallin
                [/variable]
            [then]
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Anything you can’t handle?")}
            [/then]
            [else]
                {SPEAKER_GENERIC (role=Supporter) ( _ "Anything you can’t handle?")}
            [/else]
            [/if]
            [message]
                speaker=unit
                message= _ "Nope. Should I open it?"
                [option]
                    message= _ "Go for it!"
                    [command]
                        [message]
                            speaker=narrator
                            message= _ "(<i>Crash</i>)"
                            image=misc/empty.png	# Stop wmllint from inserting Wesnoth logo
                        [/message]
                        {OPEN_DWARVEN_DOOR 27 13}
                        # Set the flags for future reference, player decided to open a door and it was the spider one
                        {VARIABLE dungeon_door[7] 1}
                        {SPEAKER_GENERIC (speaker=unit) ( _ "There we go.")}
                        {MALIFOR_CONFRONTATION}
                    [/command]
                [/option]
                [option]
                    message= _ "Just wait a sec."
                    [command]
                        {SPEAKER_GENERIC (speaker=unit) ( _ "Very well.")}
                    [/command]
                [/option]
            [/message]
        [/then]
        [else]
            [allow_undo][/allow_undo]
        [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1
            x=32
            y=12
        [/filter]

        # If we’re at the back door and they're closed
        [if]
            [variable]
                name=dungeon_door[8]
                less_than=1
            [/variable]
        [then]
            {SPEAKER_GENERIC (speaker=unit) ( _ "Hey, check this out, it looks like some sort of lever.")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "Probably for that door right there.")}
            [message]
                speaker=unit
                message= _ "Should I throw it?"
                [option]
                    message= _ "Go for it!"
                    [command]
                        {VARIABLE dungeon_door[8] 1}
                        {SPEAKER_GENERIC (speaker=unit) ( _ "Here we go!")}
                        [if]
                            [variable]
                                name=unit.id
                                not_equals=Tallin
                            [/variable]
                        [then]
                            {SPEAKER_GENERIC (speaker=unit) ( _ "(<i>Creak...</i>)")}
                            {SPEAKER_GENERIC (speaker=unit) ( _ "Nothing. That door is not moving.")}
                            {SPEAKER_GENERIC (speaker=Tallin) ( _ "Why don’t you try ‘knocking’?")}
                            {SPEAKER_GENERIC (speaker=unit) ( _ "Very well.")}
                        [/then]
                        [/if]
                        {SPEAKER_GENERIC (speaker=unit) ( _ "(<i>Bang</i>)")}
                        {SPEAKER_GENERIC (speaker=unit) ( _ "Anybody home?")}
                        {SPEAKER_GENERIC (speaker=unit) ( _ "(<i>Boom</i>)")}
                        {SPEAKER_GENERIC (speaker=unit) ( _ "(<i>Crash!</i>)")}
                        {OPEN_DWARVEN_DOOR 33 13}
                        {SPEAKER_GENERIC (speaker=unit) ( _ "There we go.")}
                        {MALIFOR_CONFRONTATION}
                    [/command]
                [/option]
                [option]
                    message= _ "Just wait a sec."
                    [command]
                        {SPEAKER_GENERIC (speaker=unit) ( _ "Very well.")}
                    [/command]
                [/option]
            [/message]
        [/then]
        [else]
            [allow_undo][/allow_undo]
        [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1
            x=28,29,30,31,32
            y=18,19,18,19,18
        [/filter]

        [if]
            # If we’re at the main door and the door are closed
            [variable]
                name=dungeon_door[9]
                less_than=1
            [/variable]
        [then]
            [message]
                speaker=unit
                message= _ "It looks like this is it. Here is the door to Malifor’s study. Are we all ready for this?"
                [option]
                    message= _ "Yeah, open those doors!"
                    [command]
                        {VARIABLE dungeon_door[9] 1}
                        [message]
                            speaker=narrator
                            message= _ "(<i>Crash</i>)"
                            image=misc/empty.png	# Stop wmllint from inserting a logo here
                        [/message]
                        {OPEN_DWARVEN_DOOR (28,29,31,32) (17,18,18,17)}
                        {SPEAKER_GENERIC (speaker=unit) ( _ "There we go.")}
                        {MALIFOR_CONFRONTATION}
                    [/command]
                [/option]
                [option]
                    message= _ "Just wait a sec."
                    [command]
                        {SPEAKER_GENERIC (speaker=unit) ( _ "Very well.")}
                    [/command]
                [/option]
            [/message]
        [/then]
        [else]
            [allow_undo][/allow_undo]
        [/else]
        [/if]
    [/event]

    {REVEAL_UNDEAD 4 reveal_undead[0]}
    {REVEAL_UNDEAD 5 reveal_undead[1]}
    {REVEAL_UNDEAD 6 reveal_undead[2]}
    {REVEAL_UNDEAD 7 reveal_undead[3]}
    {REVEAL_UNDEAD 8 reveal_undead[4]}
    {REVEAL_UNDEAD 9 reveal_undead[5]}

    [event]
        name=attack

        [filter]
            role=Dungeon Guard
        [/filter]

        {MOBILIZE_DUNGEON}
    [/event]

    [event]
        name=attack

        [filter_second]
            role=Dungeon Guard
        [/filter_second]

        {MOBILIZE_DUNGEON}
    [/event]

    [event]
        name=attack

        [filter]
            role=Study Guard
        [/filter]

        {MOBILIZE_STUDY second_unit}
    [/event]

    [event]
        name=attack

        [filter_second]
            role=Study Guard
        [/filter_second]

        {MOBILIZE_STUDY unit}
    [/event]

    [event]
        name=attack

        [filter]
            role=Treasury Guard
        [/filter]

        {MOBILIZE_TREASURY (role=Supporter)}
    [/event]

    [event]
        name=attack

        [filter_second]
            role=Treasury Guard
        [/filter_second]

        {MOBILIZE_TREASURY (role=Supporter)}
    [/event]

    {LEADER_EXPERIENCE_LIVE}

    {MALIFOR_DIED_BY pierce}
    {MALIFOR_DIED_BY blade}
    {MALIFOR_DIED_BY fire}
    {MALIFOR_DIED_BY cold}
    {MALIFOR_DIED_BY arcane}

    # Malifor can be successfully killed only by White Mages, all other units only cause him to respawn somewhere on the map. This event handles that assumption
    [event]
        name=last breath
        first_time_only=no
        [filter]
            id=Malifor
        [/filter]

        # And finally, overriding the white mages and calling scenario end
        # White Mage, Mage of Light.
        [if]
            [variable]
                name=second_unit.id
                equals=Father Morvin
            [/variable]
            [or]
                [variable]
                    name=second_unit.id
                    equals=Sister Thera
                [/variable]
            [/or]
        [then]
            {SPEAKER_GENERIC (speaker=Malifor) ( _ "AHHHH! YOU BLASTED MAGE!")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "Good. We finally got him. He is dissolving.")}
            {SPEAKER_GENERIC (speaker=Malifor) (_ "Curses on you you blasted mages, curses on you you blasted dwarves, curses on you you blasted humans, and CURSES ON YOU YOU BLASTED TALLIN! MAY YOUR MISERABLE LIVES BE FULL OF TORTURE! MAY YOUR PEOPLE NEVER BE FREE! MAY ALL YOUR NEAR AND DEAR DESERT YOU! MAY A THUNDERBOLT HIT YOUR HEAD! MAY—")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "May you shut your ugly mouth and hurry up and die.")}
            {SPEAKER_GENERIC (speaker=Malifor) ( _ "MAY THE EARTH OPEN UP AND SWALLOW YOU! MAY ALL YOUR TEETH FALL OUT! MAY YOU BECOME A WEAK SKINNY OLD MAN! MAY—")}
            {SPEAKER_GENERIC (speaker=second_unit) ( _ "Finally! He has been reduced to dust.")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "At last! Victory is ours! Good work, men!")}
            {SPEAKER_GENERIC (speaker=Father Morvin) ( _ "So, where to now, Tallin?")}
            {SPEAKER_GENERIC (speaker=Tallin) ( _ "Now, let’s get back to the dwarves and see what progress they have made in forging us weapons.")}
            {CLEAR_VARIABLE malifor_will_respawn_at_x}
            {CLEAR_VARIABLE malifor_will_respawn_at_y}
            {CLEAR_VARIABLE malifor_died_by}

            # This is only for unit convertion purpose
            [store_unit]
                [filter]
                    id=Tallin
                [/filter]
                variable=hero
            [/store_unit]

            # It is possible to get one white mage of two and complete this scenario, but this case is not present in story, so here is a little fix for this
            [if]
                [not]
                    [have_unit]
                        id=Sister Thera
                    [/have_unit]
                [/not]
            [then]
                {SPEAKER_GENERIC (speaker=Father Morvin) ( _ "Before we move, Tallin I will just find my wife. I'm sure she must be here.")}
            [/then]
            [/if]

            [if]
                [not]
                    [have_unit]
                        id=Father Morvin
                    [/have_unit]
                [/not]
            [then]
                {SPEAKER_GENERIC (speaker=Sister Thera) ( _ "Before we move, Tallin I will just find my husband. I'm sure he must be here.")}
            [/then]
            [/if]

            # It is posible also to complete this level without even knowing about Malifors' treasury, so lets put a supporter in role of pillager!
            [if]
                [variable]
                    name=mobilize_undead[1]
                    less_than=1
                [/variable]
            [then]
                {SPEAKER_GENERIC (role=Supporter) ( _ "Tallin now that Malifor is destroyed it would be good to check if there is anything useful here, like gold that we could use for our coffers.")}
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Fine, lets search this area, but don't take to long.")}
            [/then]
            [/if]

            [fire_event]
                name=victory
            [/fire_event]
        [/then]
        [else]
            # default spawn location
            [if]
                [variable]
                    name=great_chamber
                    less_than=1
                [/variable]
            [then]
                {VARIABLE malifor_spawn_location 1}
            [/then]
            [else]
                {RANDOM 1..3}
                {VARIABLE malifor_spawn_location $random}
            [/else]
            [/if]

            {VARIABLE malifor_will_respawn_at_x $malifor_spawn_x[$malifor_spawn_location]}
            {VARIABLE malifor_will_respawn_at_y $malifor_spawn_y[$malifor_spawn_location]}
            {VARIABLE malifor_spawn_x[$malifor_spawn_location] $malifor_spawn_x[0]}
            {VARIABLE malifor_spawn_y[$malifor_spawn_location] $malifor_spawn_y[0]}
            {VARIABLE malifor_spawn_x[0] $malifor_will_respawn_at_x}
            {VARIABLE malifor_spawn_y[0] $malifor_will_respawn_at_y}

            [if]
                [variable]
                    name=malifor_died
                    less_than=1
                [/variable]
            [then]
                [modify_side]
                    side=4
                    recruit=Skeleton,Skeleton Archer
                [/modify_side]

                {VARIABLE malifor_died 1}
            [/then]
            [/if]

            [store_gold]
                side=4
                variable=malifor_gold
            [/store_gold]

            [if]
                [variable]
                    name=malifor_gold
                    less_than=0
                [/variable]
            [then]
                [modify_side]
                    side=4
                    gold=300
                [/modify_side]
            [/then]
            [else]
                [gold]
                    side=4
                    amount=300
                [/gold]
            [/else]
            [/if]

            [if]
                [variable]
                    name=greate_chamber
                    numerical_equals=1
                [/variable]
            [then]
                [sound]
                    name=melee-fire.ogg
                [/sound]
                [terrain]
                    x=20
                    y=20
                    terrain=Uu
                [/terrain]

                {VARIABLE greate_chamber 2}
            [/then]
            [/if]

            [switch]
                variable=malifor_died_by
                [case]
                    value=axe
                    {SPEAKER_GENERIC (speaker=Malifor) ( _ "HAHAHA, FOOLS, YOU THINK YOU CAN KILL ME?")}
                    {MALIFOR_POWER}
                    {SPEAKER_GENERIC (speaker=Malifor) ( _ "HAHAHAHA!")}
                    {SPEAKER_GENERIC (speaker=Tallin) ( _ "What the...!")}
                    {SPEAKER_GENERIC (speaker=second_unit) ( _ "How can it be?! Our axes and hammers are failing.")}
                    {SPEAKER_GENERIC (speaker=Tallin) ( _ "Blast it! Now where did he go? Let’s find him and try something else!")}
                [/case]
                [case]
                    value=blade
                    {SPEAKER_GENERIC (speaker=Malifor) ( _ "HAHAHAHA, DEATH HAS NO EFFECT ON ME YOU FOOLS!")}
                    {MALIFOR_POWER}
                    {SPEAKER_GENERIC (speaker=Malifor) ( _ "HAHAHA, I CAN NEVER BE DESTROYED!")}
                    {SPEAKER_GENERIC (speaker=Tallin) ( _ "Oh yes you will! But... how?")}
                    {SPEAKER_GENERIC (speaker=second_unit) ( _ "Well, it sure isn’t gonna be done with a blade.")}
                    {SPEAKER_GENERIC (speaker=Tallin) ( _ "And look, he’s gone. Now we gotta find him all over again!")}
                [/case]
                [case]
                    value=pierce
                    {SPEAKER_GENERIC (speaker=Malifor) ( _ "HAHAHAHA, YOUR IDIOCY AMUSES ME GREATLY!")}
                    {MALIFOR_POWER}
                    {SPEAKER_GENERIC (speaker=Malifor) ( _ "COME AND GET ME!")}
                    {SPEAKER_GENERIC (speaker=Tallin) ( _ "Geez, how are we going to kill him?")}
                    {SPEAKER_GENERIC (speaker=second_unit) ( _ "Well, obviously clubs and arrows won’t work.")}
                    {SPEAKER_GENERIC (speaker=Tallin) ( _ "Oh darn, he disappeared. Let’s find him and try a different weapon.")}
                [/case]
                [case]
                    value=fire
                    {SPEAKER_GENERIC (speaker=Malifor) ( _ "HAHAHAHA, I AM IMMORTAL!")}
                    {MALIFOR_POWER}
                    {SPEAKER_GENERIC (speaker=Malifor) ( _ "YOU PUNY MORTALS SHALL SOON BE SERVING ME!")}
                    {SPEAKER_GENERIC (speaker=Camerin) ( _ "That blasted skeleton! Even fire has no affect on him!")}
                    {SPEAKER_GENERIC (speaker=Tallin) ( _ "Look, he disappeared again. Let’s find him and try using a different weapon on him.")}
                [/case]
                [else]
                    {SPEAKER_GENERIC (speaker=Malifor) ( _ "HAHAHA, FOOLS, YOU THINK YOU CAN KILL ME?")}
                    {MALIFOR_POWER}
                    {SPEAKER_GENERIC (speaker=Malifor) ( _ "HAHAHAHA!")}
                    {SPEAKER_GENERIC (speaker=Tallin) ( _ "What the—")}
                    {SPEAKER_GENERIC (speaker=Tallin) ( _ "Blast it! Now where did he go? Let’s find him and try something else!")}
                [/else]
            [/switch]

            [if]
                [have_unit]
                    id=Father Morvin
                [/have_unit]
                [and]
                    [have_unit]
                        id=Sister Thera
                    [/have_unit]
                [/and]
                [and]
                    [variable]
                        name=malifor_immunity_speak
                        less_than=1
                    [/variable]
                [/and]
            [then]
                {SPEAKER_GENERIC (speaker=Father Morvin) ( _ "I see now. It is impossible to destroy him by ordinary means.")}
                {SPEAKER_GENERIC (speaker=Tallin) ( _ "Then how are we going to destroy him? Surely there must be a way.")}
                {SPEAKER_GENERIC (speaker=Father Morvin) ( _ "Yes, I think there is, but only myself or Thera have the means to do it. Come on Thera, let’s destroy that old skeleton.")}
                {SPEAKER_GENERIC (speaker=Sister Thera) ( _ "Yeah, I can’t wait to get my hands on that bastard!")}
                {SPEAKER_GENERIC (speaker=Father Morvin) ( _ "That was very unladylike of you.")}
                {SPEAKER_GENERIC (speaker=Sister Thera) ( _ "(<i>Giggle</i>) Sorry.")}

                {VARIABLE malifor_immunity_speak 1}
            [/then]
            [/if]
            {CLEAR_VARIABLE malifor_will_respawn_at_x}
            {CLEAR_VARIABLE malifor_will_respawn_at_y}
            {CLEAR_VARIABLE malifor_died_by}
            {CLEAR_VARIABLE malifor_gold}
        [/else]
        [/if]
    [/event]

    # Set up a flavour death event for the pair since they can't die in combat (see utils/herodeaths.cfg)
    [event]
        name=resurrection

        {SPEAKER_GENERIC (speaker=Tallin) ( _ "Wow! That’s incredible. Now I understand why the bag of bones kept you guys in jail; he just simply couldn’t kill you!")}
        {SPEAKER_GENERIC (speaker=Sister Thera) ( _ "(<i>Giggle</i>)")}
    [/event]

    {IMPORTANT_CHARACTER_DIED "Sister Thera"}
    {IMPORTANT_CHARACTER_DIED "Father Morvin"}

    [event]
        name=victory

        {CLEAR_VARIABLE confronted_malifor}
        {CLEAR_VARIABLE got_rod_of_justice}
        {CLEAR_VARIABLE malifor_died}
        {CLEAR_VARIABLE mage_death_pursuit}
        {CLEAR_VARIABLE malifor_immunity_speak}
        {CLEAR_VARIABLE forces_undead}
        {CLEAR_VARIABLE beholder_gate}
        {CLEAR_VARIABLE beholder_gate_lock}
        {CLEAR_VARIABLE fighters1}
        {CLEAR_VARIABLE fighters2}
        {CLEAR_VARIABLE order_attack}
        {CLEAR_VARIABLE mauler_dwarf}
        {CLEAR_VARIABLE taunt_free}
        {CLEAR_VARIABLE taunt_speak}
        {CLEAR_VARIABLE assaults}
        {CLEAR_VARIABLE malifor_dungeon}
        {CLEAR_VARIABLE great_chamber}
        {CLEAR_VARIABLE dungeon_door}
        {CLEAR_VARIABLE mobilize_undead}
        {CLEAR_VARIABLE reveal_undead}
        {CLEAR_VARIABLE reveal_monsters}
        {CLEAR_VARIABLE underground_lake}
        {CLEAR_VARIABLE malifor_spawn_x}
        {CLEAR_VARIABLE malifor_spawn_y}
        {CLEAR_VARIABLE random}
        {CLEAR_VARIABLE bones_encounter}
        {CLEAR_VARIABLE bones_free}
        {CLEAR_VARIABLE bones_state}
        {CLEAR_VARIABLE caprive_cell}
        {CLEAR_VARIABLE cell_bones}
        {CLEAR_VARIABLE cell_free}
        {CLEAR_VARIABLE cell_location}
        {CLEAR_VARIABLE captive}
        {CLEAR_VARIABLE prisoner_dead}
        {CLEAR_VARIABLE bones_encounter}
        {CLEAR_VARIABLE gold_chest}
        {CLEAR_VARIABLE chest_free}
        {CLEAR_VARIABLE chest}
        {CLEAR_VARIABLE malifor_mage_speak}
        {CLEAR_VARIABLE malifor_spawn_location}
        {CLEAR_VARIABLE pile_free}
        {CLEAR_VARIABLE pile}
        {CLEAR_VARIABLE bones}

        {VICTORY_BONUS_ALL yes}
    [/event]

    # And the usual batch of hero death macros
    {~add-ons/Northern_Rebirth_Remake/utils/herodeaths.cfg}
    #undef MALIFOR_DIED_BY
    #undef MALIFOR_POWER
    #undef MALIFOR_ABILITIES
    #undef FORCES_UNDEAD
    #undef BEHOLDER_GATE
    #undef ORDER_ATTACK
    #undef FORCE_UNDEAD
    #undef GATE_ASSAULT
    #undef SPEAKER_ASSAULTER
    #undef OBJECTIVES_PURSUIT
    #undef AI_UNDEAD
    #undef UNIT_AI_GUARD
    #undef PUT_MALIFOR_GUARD
    #undef RECALL_MAULER
    #undef RECALL_DWARVEN_MAULER
    #undef MAULER
    #undef GOLD_CHEST
    #undef DWARVEN_DOOR
    #undef OPEN_DWARVEN_DOOR
    #undef COMMAND_DOOR
    #undef COMMAND_DOOR_STORAGE1
    #undef COMMAND_DOOR_STORAGE2
    #undef AREA_DESCRIPTION
    #undef AREA_STORAGE
    #undef AREA_STORAGE_SPEAK
    #undef CORPSE
    #undef BLIND_END
    #undef REMOVE_TERRAIN_OBJECT
    #undef PRISONER_KRASH
    #undef PRISONER_ELENIA
    #undef PRISONER_THERA
    #undef PRISONER_MORVIN
    #undef PRISONER_DEAD
    #undef PUT_PRISONER
    #undef PUT_GOLD_CHEST
    #undef PUT_BONES
    #undef REVEAL_SIDE
    #undef NAGA_ENCOUNTER
    #undef BONES_ENCOUNTER
    #undef TREASURE_ARTIFACT
    #undef TREASURE_BONES
    #undef TREASURE_GOLD
    #undef TREASURE_DUST
    #undef PUT_TREASURE
    #undef HAUNTED_TUNNEL
    #undef MALIFOR_MAGE_SPEAK
    #undef CONFRONTATION_PURSUIT
    #undef MALIFOR_CONFRONTATION
    #undef UNDEAD_WARRIORS
    #undef MOBILIZE_DUNGEON
    #undef MOBILIZE_TREASURY
    #undef MOBILIZE_STUDY
    #undef UNDEAD_TROOPS_LIGHT
    #undef UNDEAD_TROOPS_HEAVY
    #undef BEGIN_PURSUIT
[/scenario]
